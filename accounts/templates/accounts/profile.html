{% extends "base.html" %}
{% load static %}
{% load avatar %}
{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
  :root { --primary-color:#9370DB; --secondary-color:#F472B6; --accent-color:#A78BFA; --text-primary:#1e293b; --text-secondary:#475569; --border-color: rgba(147,112,219,0.25); --surface:#ffffff; --surface-soft:#f6f7fb; }
  .icon-inline { margin-right: 0.5rem; }
  .icon-badge-soft { display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:8px; background: rgba(147,112,219,0.14); color:#6d28d9; }
  .profile-cover { height:220px; background: linear-gradient(135deg, #7c3aed 0%, #f472b6 50%, #60a5fa 100%); position:relative; overflow:hidden; border-radius:24px; box-shadow: 0 18px 40px rgba(17,24,39,0.12); }
  .profile-cover::after { content:""; position:absolute; inset:0; background: radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.35), transparent 60%), radial-gradient(ellipse at 80% 0%, rgba(255,255,255,0.25), transparent 50%); }
  .profile-info-container { max-width:900px; margin:0 auto; position:relative; }
  .profile-avatar-container { position:absolute; top:-64px; left:24px; z-index:10; }
  .profile-avatar { width:128px; height:128px; border-radius:50%; border:6px solid var(--surface); box-shadow:0 10px 28px rgba(17,24,39,0.18); object-fit:cover; }
  .profile-header-content { background: var(--surface); border-radius:20px; padding: 70px 18px 20px 170px; margin-top:-48px; box-shadow: 0 12px 36px rgba(17,24,39,0.10); border: 1px solid rgba(17,24,39,0.06); }
  .profile-name { font-size:1.5rem; font-weight:700; color:var(--text-primary); margin:0; }
  .profile-username { color:var(--text-secondary); font-size:0.95rem; margin:2px 0 8px; }
  .stat-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:14px; }
  @media (min-width:640px){ .stat-grid { grid-template-columns: repeat(4, minmax(0,1fr)); } }
  .stat-card { background: var(--surface-soft); border: 1px solid rgba(17,24,39,0.06); border-radius:16px; padding:12px; display:flex; align-items:center; gap:10px; box-shadow: 0 6px 18px rgba(17,24,39,0.06); }
  .stat-icon { width:36px; height:36px; border-radius:12px; display:inline-flex; align-items:center; justify-content:center; color:#32612d; background: rgba(50,97,45,0.08); }
  .stat-value { font-weight:700; font-size:1.1rem; color:var(--text-primary); }
  .stat-label { font-size:0.8rem; color:var(--text-secondary); }
  .rating-ring { width:64px; height:64px; border-radius:50%; background: conic-gradient(#22c55e calc(var(--value) * 20%), #e5e7eb 0); position:relative; display:grid; place-items:center; box-shadow: 0 6px 16px rgba(17,24,39,0.08); }
  .rating-ring .ring-inner { width:48px; height:48px; border-radius:50%; background: var(--surface); display:flex; align-items:center; justify-content:center; font-weight:700; color:#22c55e; }
  .timeline { display:flex; flex-direction:column; gap:10px; }
  .timeline-item { background: var(--surface-soft); border: 1px solid rgba(17,24,39,0.06); border-radius:14px; padding:10px 12px; box-shadow: 0 6px 16px rgba(17,24,39,0.06); }
  .timeline-title { font-weight:600; color:var(--text-primary); display:flex; align-items:center; gap:8px; }
  .timeline-meta { font-size:0.8rem; color:var(--text-secondary); }
</style>
{% endblock %}
{% block title %}My Profile • PETio{% endblock %}

{% block content %}
<div class="profile-content container mx-auto max-w-4xl py-6">
  <div class="profile-cover"></div>
  <div class="profile-info-container">
    <div class="profile-avatar-container">
      <img class="profile-avatar" src="{% avatar_url user_obj 128 %}" alt="{{ user_obj.username }} avatar">
    </div>
    <div class="profile-header-content">
      <div class="flex items-center justify-between mb-2">
        <div>
          <h1 class="profile-name">{{ user_obj.get_full_name|default:user_obj.username }}</h1>
          <div class="profile-username">@{{ user_obj.username }}</div>
          <div class="text-sm text-gray-500">{{ user_obj.email }}</div>
          <div class="text-sm text-gray-500">Member since {{ user_obj.date_joined|date:"M d, Y" }}</div>
        </div>
        <div class="flex items-center gap-2">
          <a href="{% url 'accounts:profile_edit' %}" class="btn btn-ghost btn-sm"><i class="fas fa-edit"></i> Edit</a>
        </div>
      </div>
      <div class="stat-grid">
        <div class="stat-card">
          <span class="stat-icon"><i class="fas fa-feather"></i></span>
          <div>
            <div class="stat-value">{{ user_obj.social_posts.count|default:0 }}</div>
            <div class="stat-label">Posts</div>
          </div>
        </div>
        <div class="stat-card">
          <span class="stat-icon"><i class="fas fa-user-plus"></i></span>
          <div>
            <div class="stat-value">{{ user_obj.social_followers_set.count|default:0 }}</div>
            <div class="stat-label">Followers</div>
          </div>
        </div>
        <div class="stat-card">
          <span class="stat-icon"><i class="fas fa-user-friends"></i></span>
          <div>
            <div class="stat-value">{{ user_obj.social_following_set.count|default:0 }}</div>
            <div class="stat-label">Following</div>
          </div>
        </div>
        <div class="stat-card">
          <span class="stat-icon"><i class="fas fa-store"></i></span>
          <div>
            <div class="stat-value">{{ user_obj.listings.count|default:0 }}</div>
            <div class="stat-label">Listings</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  

  

  <div class="enhanced-card mb-4">
    <div class="section-title flex items-center justify-between">
      <span><span class="icon-badge-soft icon-inline"><i class="fas fa-star"></i></span> Seller Ratings</span>
      <button type="button" class="btn btn-ghost btn-sm btn-enhanced collapse-toggle" data-target="#ratingsBodyAcc"><i class="fas fa-chevron-up"></i></button>
    </div>
    <div id="ratingsBodyAcc">
      <div class="flex items-center gap-4 mb-3">
        <div class="rating-ring" style="--value: {{ seller_rating_avg|default:0|floatformat:2 }}">
          <div class="ring-inner">{{ seller_rating_avg|floatformat:1 }}</div>
        </div>
        <div>
          <div class="font-semibold">Average <span class="opacity-70">/ 5</span></div>
          <div class="text-sm opacity-70">{{ seller_rating_count }} total reviews</div>
        </div>
      </div>
      {% if seller_rating_count > 0 %}
        <div>
          <div class="subsection-title"><i class="fas fa-history"></i> Recent Reviews</div>
          <ul class="space-y-2">
            {% for r in recent_ratings %}
              <li class="timeline-item">
                <div class="timeline-title">
                  <i class="fas fa-star text-yellow-400"></i> {{ r.score }}/5 from @{{ r.buyer.username }}
                </div>
                {% if r.listing %}<div class="timeline-meta">on {{ r.listing.title }} • {{ r.created_at|date:"M d, Y" }}</div>{% else %}
                <div class="timeline-meta">{{ r.created_at|date:"M d, Y" }}</div>{% endif %}
                {% if r.comment %}<div class="text-sm mt-1">“{{ r.comment }}”</div>{% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% else %}
        <div class="text-sm opacity-70">No reviews yet.</div>
      {% endif %}
    </div>
  </div>

  <div class="enhanced-card mb-4">
    <div class="section-title flex items-center justify-between">
      <span><span class="icon-badge-soft icon-inline"><i class="fas fa-stream"></i></span> Activity</span>
      <button type="button" class="btn btn-ghost btn-sm btn-enhanced collapse-toggle" data-target="#activityBodyAcc"><i class="fas fa-chevron-up"></i></button>
    </div>
    <div id="activityBodyAcc" class="timeline">
      {% if recent_ratings %}
        {% for r in recent_ratings %}
          <div class="timeline-item">
            <div class="timeline-title"><i class="fas fa-star text-yellow-400"></i> Received a {{ r.score }}/5 rating from @{{ r.buyer.username }}</div>
            <div class="timeline-meta">{{ r.created_at|date:"M d, Y" }}{% if r.listing %} • on {{ r.listing.title }}{% endif %}</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-sm opacity-70">No recent activity</div>
      {% endif %}
    </div>
  </div>

  <div class="enhanced-card">
    <div class="section-title flex items-center justify-between">
      <span><span class="icon-badge-soft icon-inline"><i class="fas fa-user"></i></span> Profile Details</span>
      <button type="button" class="btn btn-ghost btn-sm btn-enhanced collapse-toggle" data-target="#detailsBodyAcc"><i class="fas fa-chevron-up"></i></button>
    </div>
    <div id="detailsBodyAcc" class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div><div class="text-sm text-gray-500">Display Name</div><div class="font-medium">{{ user_obj.profile.display_name|default:"(not set)" }}</div></div>
      <div><div class="text-sm text-gray-500">Location</div><div class="font-medium">{{ user_obj.profile.location|default:"(not set)" }}</div></div>
      <div><div class="text-sm text-gray-500">Phone</div><div class="font-medium">{{ user_obj.profile.phone|default:"(not set)" }}</div></div>
      <div class="md:col-span-2"><div class="text-sm text-gray-500">Bio</div><div class="font-medium">{{ user_obj.profile.bio|default:"(not set)" }}</div></div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/auth.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('.collapse-toggle').forEach(function(btn){
    btn.addEventListener('click', function(){
      var targetSel = this.getAttribute('data-target');
      var target = document.querySelector(targetSel);
      if (!target) return;
      var isHidden = target.classList.toggle('hidden');
      var icon = this.querySelector('i');
      if (icon) icon.className = isHidden ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
    });
  });
});
</script>
{% endblock %}

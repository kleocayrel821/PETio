<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Feeder Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Modern Glassmorphism theme for the Control Panel (CSS-only redesign) */
        :root {
            --primary-color: #4f46e5;      /* indigo-600 */
            --primary-700: #4338ca;        /* indigo-700 */
            --accent-color: #22c55e;       /* green-500 */
            --danger-color: #ef4444;       /* red-500 */
            --text-color: #111827;         /* gray-900 */
            --muted-text: #6b7280;         /* gray-500 */
            --surface: rgba(255, 255, 255, 0.72);
            --surface-strong: rgba(255, 255, 255, 0.85);
            --border: rgba(17, 24, 39, 0.08);
            --shadow-lg: 0 10px 30px rgba(31, 41, 55, 0.12);
            --shadow-sm: 0 4px 12px rgba(31, 41, 55, 0.08);
            --card-radius: 16px;
            --transition-speed: 0.25s;
        }

        body {
            padding-top: 2rem;
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:
                radial-gradient(1200px 600px at 0% 0%, #eef2ff 0%, transparent 60%),
                radial-gradient(1200px 600px at 100% 0%, #ecfeff 0%, transparent 60%),
                radial-gradient(1200px 600px at 50% 100%, #f0fdf4 0%, transparent 60%),
                linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
            min-height: 100vh;
        }

        h1 {
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--primary-color), #06b6d4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Card (glass) */
        .card {
            margin-bottom: 1.5rem;
            border-radius: var(--card-radius);
            border: 1px solid var(--border);
            background: var(--surface);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-700));
            color: white;
            font-weight: 700;
            letter-spacing: 0.2px;
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.25rem;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-700));
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.25rem;
            font-weight: 700;
            letter-spacing: 0.3px;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed), filter var(--transition-speed);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            filter: brightness(1.04);
            box-shadow: 0 10px 22px rgba(79, 70, 229, 0.35);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f43f5e, var(--danger-color));
            border: none;
            border-radius: 12px;
            font-weight: 700;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed), filter var(--transition-speed);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.25);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            filter: brightness(1.05);
            box-shadow: 0 10px 22px rgba(239, 68, 68, 0.35);
        }

        /* Forms */
        .form-control, .form-select {
            border-radius: 12px;
            padding: 0.7rem 1rem;
            border: 1px solid var(--border);
            background: var(--surface-strong);
            transition: all var(--transition-speed);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.15);
        }

        .form-range { height: 6px; }
        .form-range::-webkit-slider-thumb {
            background: var(--primary-color);
            box-shadow: 0 0 0 6px rgba(79, 70, 229, 0.15);
        }

        /* Tables */
        .table { border-collapse: separate; border-spacing: 0 8px; }
        .table thead th {
            border-bottom: none;
            color: var(--muted-text);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.78rem;
            letter-spacing: 1px;
        }
        .table tbody tr {
            background: var(--surface-strong);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }
        .table tbody tr:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .table tbody td { padding: 1rem; vertical-align: middle; }

        /* Logs scroll */
        #feedingLogs { max-height: 300px; overflow-y: auto; scrollbar-width: thin; }
        #feedingLogs::-webkit-scrollbar { width: 6px; }
        #feedingLogs::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 10px; }
        #feedingLogs::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }

        /* Feed now */
        .feed-now-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem;
        }
        .feed-now-btn {
            width: 160px; height: 160px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.6rem; margin-bottom: 1.25rem; color: white; border: 0;
            background: conic-gradient(from 210deg at 50% 50%, var(--primary-color), var(--primary-700));
            box-shadow: 0 18px 35px rgba(79, 70, 229, 0.35), inset 0 -6px 12px rgba(0,0,0,0.15);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed), filter var(--transition-speed);
        }
        .feed-now-btn:hover { transform: scale(1.04); filter: brightness(1.03); box-shadow: 0 24px 40px rgba(79, 70, 229, 0.45), inset 0 -8px 14px rgba(0,0,0,0.18); }
        .feed-now-btn:active { transform: scale(0.98); }
        .feed-now-btn i { font-size: 3rem; margin-bottom: 0.4rem; }

        /* Portion control */
        .portion-control {
            width: 100%; padding: 1.5rem; background: var(--surface-strong); border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
        }
        .portion-value { font-size: 2.1rem; font-weight: 800; color: var(--primary-color); text-align: center; margin-bottom: 1rem; }
        .portion-label { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-weight: 600; color: var(--muted-text); }

        /* Schedules */
        .schedule-item { background: var(--surface-strong); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-sm); transition: transform var(--transition-speed); }
        .schedule-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .schedule-time { font-size: 1.2rem; font-weight: 700; }
        .schedule-portion { color: var(--muted-text); }

        .form-switch .form-check-input { width: 3em; height: 1.5em; }
        .form-switch .form-check-input:checked { background-color: var(--primary-color); border-color: var(--primary-color); }

        @media (max-width: 768px) {
            .feed-now-btn { width: 124px; height: 124px; font-size: 1.2rem; }
            .feed-now-btn i { font-size: 2.4rem; }
            .portion-value { font-size: 1.6rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Pet Feeder Control Panel</h1>
        
        <div class="card">
            <div class="card-header">Feed Now &amp; Portion Control</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="feed-now-container">
                            <button id="feedNowBtn" class="feed-now-btn">
                                <div>
                                    <i class="fas fa-utensils"></i>
                                    <div>Feed Now</div>
                                </div>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div>
                            <div class="portion-value" id="portionValue">100g</div>
                            <div class="portion-control">
                                <div class="portion-label">
                                    <span>25g</span>
                                    <span>500g</span>
                                </div>
                                <input type="range" class="form-range" id="portionSize" min="25" max="500" step="5" value="100">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Schedule Feeding Section -->
        <div class="card">
            <div class="card-header">Schedule Feeding</div>
            <div class="card-body">
                <form id="addScheduleForm" class="row g-3 mb-4" novalidate aria-describedby="scheduleFormErrors">
                    <div class="col-md-3">
                        <label for="scheduleTime" class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime" required aria-required="true" aria-invalid="false" aria-describedby="scheduleTimeError">
                        <div id="scheduleTimeError" class="text-danger small" role="alert" aria-live="polite" style="display:none"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="schedulePortion" class="form-label">Portion (g)</label>
                        <input type="number" class="form-control" id="schedulePortion" min="25" max="500" required aria-required="true" aria-invalid="false" aria-describedby="schedulePortionError">
                        <div id="schedulePortionError" class="text-danger small" role="alert" aria-live="polite" style="display:none"></div>
                    </div>
                    <div class="col-md-3">
                        <label for="scheduleLabel" class="form-label">Label (optional)</label>
                        <input type="text" class="form-control" id="scheduleLabel" maxlength="20" placeholder="e.g., Breakfast">
                    </div>
                    <div class="col-md-12">
                        <label class="form-label d-block" for="scheduleDaysContainer">Days of Week</label>
                        <div id="scheduleDaysContainer" class="d-flex flex-wrap gap-2" aria-describedby="scheduleDaysError">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input dow-checkbox" type="checkbox" id="dowMon" value="Mon" checked>
                                <label class="form-check-label" for="dowMon">Mon</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input dow-checkbox" type="checkbox" id="dowTue" value="Tue" checked>
                                <label class="form-check-label" for="dowTue">Tue</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input dow-checkbox" type="checkbox" id="dowWed" value="Wed" checked>
                                <label class="form-check-label" for="dowWed">Wed</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input dow-checkbox" type="checkbox" id="dowThu" value="Thu" checked>
                                <label class="form-check-label" for="dowThu">Thu</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input dow-checkbox" type="checkbox" id="dowFri" value="Fri" checked>
                                <label class="form-check-label" for="dowFri">Fri</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input dow-checkbox" type="checkbox" id="dowSat" value="Sat" checked>
                                <label class="form-check-label" for="dowSat">Sat</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input dow-checkbox" type="checkbox" id="dowSun" value="Sun" checked>
                                <label class="form-check-label" for="dowSun">Sun</label>
                            </div>
                        </div>
                        <div id="scheduleDaysError" class="text-danger small" role="alert" aria-live="polite" style="display:none"></div>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">Add Schedule</button>
                    </div>
                </form>
                <table class="table" id="scheduleTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Portion</th>
                            <th>Label</th>
                            <th>Days</th>
                            <th>Enabled</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Schedule rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Feeding Logs Section -->
        <div class="card mt-4">
            <div class="card-header">Feeding Logs</div>
            <div class="card-body">
                <div class="table-responsive" id="feedingLogs">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Portion</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody id="logsList"></tbody>
                    </table>
                </div>
                <div class="row g-2 align-items-end mt-2" id="logsFilters">
                    <div class="col-sm-4 col-md-3">
                        <label for="logsStartDate" class="form-label">From</label>
                        <input type="date" id="logsStartDate" class="form-control" aria-label="Filter start date">
                    </div>
                    <div class="col-sm-4 col-md-3">
                        <label for="logsEndDate" class="form-label">To</label>
                        <input type="date" id="logsEndDate" class="form-control" aria-label="Filter end date">
                    </div>
                    <div class="col-sm-4 col-md-3 d-flex gap-2">
                        <button class="btn btn-primary" id="applyLogsFilters" aria-label="Apply date filters">Apply</button>
                        <button class="btn btn-outline-secondary" id="clearLogsFilters" aria-label="Clear date filters">Clear</button>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-2">
                    <div>
                        <button class="btn btn-outline-secondary btn-sm" id="logsPrevBtn" aria-label="Previous page">Prev</button>
                        <button class="btn btn-outline-secondary btn-sm ms-2" id="logsNextBtn" aria-label="Next page">Next</button>
                    </div>
                    <div id="logsPageInfo" class="text-muted small" aria-live="polite">Page 1</div>
                </div>
            </div>
        </div>
        <script>
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Helper function to show toast notifications
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3';
            toast.style.zIndex = '11';
            toast.innerHTML = `
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <strong class="me-auto">Pet Feeder</strong>
                        <small>Just now</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body ${type === 'danger' ? 'text-danger' : ''}">
                        ${message}
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }
        
        // Utility: Simple debounce to rate-limit frequent actions
        function debounce(fn, delay = 300) {
            let t;
            return function(...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), delay);
            };
        }
        
        // Helper: Collect selected days within a container (inline form or modal)
        // Returns an array of day abbreviations like ["Mon","Tue",...]
        function getSelectedDays(containerEl) {
            const days = [];
            containerEl.querySelectorAll('.dow-checkbox').forEach(chk => { if (chk.checked) days.push(chk.value); });
            return days;
        }
        
        // Helper: Set selected days in a container given an array of abbreviations
        function setSelectedDays(containerEl, days) {
            const set = new Set(days || []);
            containerEl.querySelectorAll('.dow-checkbox').forEach(chk => { chk.checked = set.has(chk.value); });
        }
        
        // Helper: Convert serializer time to input[type=time] value (HH:MM)
        // Accepts either "HH:MM" or "hh:mm:ss AM/PM" and returns "HH:MM"
        function timeToInputValue(timeStr) {
            if (!timeStr) return '';
            const hasMeridiem = /AM|PM/i.test(timeStr);
            if (!hasMeridiem) {
                const parts = timeStr.split(':');
                return `${parts[0].padStart(2,'0')}:${parts[1]}`;
            }
            const [hm, , ampmRaw] = timeStr.split(' ');
            let [h, m] = hm.split(':');
            let hour = parseInt(h, 10);
            const ampm = ampmRaw.toUpperCase();
            if (ampm === 'PM' && hour !== 12) hour += 12;
            if (ampm === 'AM' && hour === 12) hour = 0;
            return `${hour.toString().padStart(2,'0')}:${m}`;
        }
        
        // Helper: Convert input HH:MM to 12-hour format with seconds for serializer input
        function to12HourWithSeconds(hhmm) {
            const [hStr, m] = hhmm.split(':');
            let h = parseInt(hStr, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            let h12 = h % 12; if (h12 === 0) h12 = 12;
            return `${h12.toString().padStart(2,'0')}:${m}:00 ${ampm}`;
        }
        
        // Render a group of days-of-week checkboxes for a schedule row
        // selectedDays: array like ["Mon","Tue",...]
        function renderDaysCheckboxes(selectedDays = []) {
            const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            const set = new Set(selectedDays || []);
            return days.map(day => `
                <div class="form-check form-check-inline">
                    <input class="form-check-input dow-checkbox" type="checkbox" value="${day}" ${set.has(day) ? 'checked' : ''}>
                    <label class="form-check-label">${day}</label>
                </div>
            `).join('');
        }
        
        // Use direct DOM lookup to avoid temporal dead zone error before variable initialization
        document.getElementById('addScheduleForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formEl = e.target;
            const timeInput = formEl.querySelector('#scheduleTime');
            const portionInput = formEl.querySelector('#schedulePortion');
            const daysContainer = formEl.querySelector('#scheduleDaysContainer');
            const timeRaw = timeInput.value;
            const portionRaw = portionInput.value;
            const labelRaw = (formEl.querySelector('#scheduleLabel').value || '').trim();
            const days = getSelectedDays(formEl);
        
            // Reset errors
            const timeErr = formEl.querySelector('#scheduleTimeError');
            const portionErr = formEl.querySelector('#schedulePortionError');
            const daysErr = formEl.querySelector('#scheduleDaysError');
            [timeErr, portionErr, daysErr].forEach(el => { if (el) { el.style.display = 'none'; el.textContent = ''; } });
            timeInput.setAttribute('aria-invalid', 'false');
            portionInput.setAttribute('aria-invalid', 'false');
            daysContainer && daysContainer.setAttribute('aria-invalid', 'false');
        
            // Validate fields
            let hasError = false;
            if (!timeRaw) {
                timeErr.textContent = 'Time is required.';
                timeErr.style.display = 'block';
                timeInput.setAttribute('aria-invalid', 'true');
                hasError = true;
            }
            const portionVal = parseFloat(portionRaw);
            if (!timeRaw || !portionRaw || isNaN(portionVal) || portionVal < 25 || portionVal > 500 || days.length === 0) {
                showToast('Please provide valid time, portion between 25-500g, and select at least one day.', 'warning');
                return;
            }
            if (!days || days.length === 0) {
                daysErr.textContent = 'Select at least one day of the week.';
                daysErr.style.display = 'block';
                daysContainer && daysContainer.setAttribute('aria-invalid', 'true');
                hasError = true;
            }
        
            if (hasError) {
                showToast('Please fix the errors in the form.', 'warning');
                return;
            }
        
            const scheduleData = {
                time: to12HourWithSeconds(timeRaw),
                portion_size: portionVal,
                label: labelRaw, // do not send null; backend CharField expects string
                days_of_week: days,
                enabled: true
            };
        
            fetch('/api/schedules/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(scheduleData)
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to add schedule');
                return response.json();
            })
            .then(() => {
                showToast('Schedule added successfully!', 'success');
                formEl.reset();
                // Default: check all days again after reset
                setSelectedDays(formEl, ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']);
                loadSchedules();
            })
            .catch(err => {
                console.error('Add schedule error:', err);
                showToast('Failed to add schedule. Please try again.', 'danger');
            });
        });
        
        // Load Schedules (duplicate definition removed)

        // Save Schedule (inline row PUT)
        function saveSchedule(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return;
            const timeInput = row.querySelector('.schedule-time');
            const portionInput = row.querySelector('.schedule-portion');
            const labelInput = row.querySelector('.schedule-label');
            const enabledInput = row.querySelector('.schedule-enabled');
        
            const timeRaw = timeInput.value;
            const portionRaw = portionInput.value;
            const labelRaw = (labelInput.value || '').trim();
            const enabledRaw = !!enabledInput.checked;
        
            const days = [];
            row.querySelectorAll('.dow-checkbox').forEach(chk => { if (chk.checked) days.push(chk.value); });
        
            // Basic validation
            const portionVal = parseFloat(portionRaw);
            if (!timeRaw || !portionRaw || isNaN(portionVal) || portionVal < 25 || portionVal > 500 || days.length === 0) {
                showToast('Please provide valid time, portion between 25-500g, and select at least one day.', 'warning');
                return;
            }
        
            const payload = {
                time: to12HourWithSeconds(timeRaw),
                portion_size: portionVal,
                label: labelRaw, // send empty string if blank; backend CharField does not accept null
                days_of_week: days,
                enabled: enabledRaw
            };
        
            const saveBtn = row.querySelector('button.btn-success');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
            }
        
            fetch(`/api/schedules/${id}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to update schedule');
                return response.json();
            })
            .then(() => {
                showToast('Schedule updated successfully!', 'success');
                loadSchedules();
            })
            .catch(err => {
                console.error('Update schedule error:', err);
                showToast('Failed to update schedule. Please try again.', 'danger');
            })
            .finally(() => {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                }
            });
        }

        // Format time for display (HH:MM to 12-hour format)
        function formatTime(timeString) {
            const timeParts = timeString.split(':');
            const hour = parseInt(timeParts[0]);
            const minute = timeParts[1];
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 === 0 ? 12 : hour % 12;
            return `${displayHour}:${minute} ${period}`;
        }
        
        // Load Schedules
        function loadSchedules() {
            fetch('/api/schedules/?page_size=100&ordering=-id', {
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#scheduleTable tbody');
                tbody.innerHTML = '';
                // Support both array and paginated responses
                const results = Array.isArray(data) ? data : (data.results || []);
                // Sort by id descending so the most recently added schedule appears first (server already orders, but keep as safety)
                results.sort((a, b) => (b.id || 0) - (a.id || 0));
        
                results.forEach(schedule => {
                    const displayTime = timeToInputValue(schedule.time);
                    const labelValue = schedule.label || '';
                    const days = Array.isArray(schedule.days_of_week) ? schedule.days_of_week : [];
                    const rowHtml = `
                        <tr data-id="${schedule.id}">
                            <td><input type="time" value="${displayTime}" class="form-control schedule-time" /></td>
                            <td><input type="number" value="${schedule.portion_size}" min="25" max="500" class="form-control schedule-portion" /></td>
                            <td><input type="text" value="${labelValue}" maxlength="20" class="form-control schedule-label" placeholder="Label (optional)" /></td>
                            <td>${renderDaysCheckboxes(days)}</td>
                            <td><input type="checkbox" ${schedule.enabled ? 'checked' : ''} class="form-check-input schedule-enabled" onchange="toggleSchedule(${schedule.id}, this.checked)" /></td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="saveSchedule(${schedule.id})">Save</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteSchedule(${schedule.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', rowHtml);
                });
            })
            .catch(error => console.error('Error:', error));
        }

        // Toggle Schedule
        function toggleSchedule(id, enabled) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            const toggleSwitch = row.querySelector('.schedule-enabled');
            toggleSwitch.disabled = true;
            
            fetch(`/api/schedules/${id}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed');
                return response.json();
            })
            .then(data => {
                // Show success notification
                showToast(`Schedule ${enabled ? 'enabled' : 'disabled'} successfully!`, 'success');
                toggleSwitch.disabled = false;
                // Reload to reflect active-only filters elsewhere
                loadSchedules();
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert the toggle if there was an error
                toggleSwitch.checked = !enabled;
                toggleSwitch.disabled = false;
                showToast(`Failed to ${enabled ? 'enable' : 'disable'} schedule. Please try again.`, 'danger');
            });
        }

        // Delete Schedule
        function deleteSchedule(id) {
            if (confirm('Are you sure you want to delete this schedule?')) {
                fetch(`/api/schedules/${id}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (response.ok) {
                        showToast('Schedule deleted successfully', 'success');
                        loadSchedules();
                    } else {
                        throw new Error('Failed to delete schedule');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Failed to delete schedule', 'danger');
                });
            }
        }

        // Initial data load
        // Wire up core UI interactions and start polling
        const portionSlider = document.getElementById('portionSize');
        const portionValue = document.getElementById('portionValue');
        const feedNowBtn = document.getElementById('feedNowBtn');
        const addScheduleForm = document.getElementById('addScheduleForm');

        // Update portion size display as the slider moves
        portionSlider.addEventListener('input', () => {
            portionValue.textContent = `${portionSlider.value}g`;
        });

        // Feeding Logs: pagination and rendering
        const logsList = document.getElementById('logsList');
        const logsPrevBtn = document.getElementById('logsPrevBtn');
        const logsNextBtn = document.getElementById('logsNextBtn');
        const logsPageInfo = document.getElementById('logsPageInfo');
        const logsStartDate = document.getElementById('logsStartDate');
        const logsEndDate = document.getElementById('logsEndDate');
        const applyLogsFiltersBtn = document.getElementById('applyLogsFilters');
        const clearLogsFiltersBtn = document.getElementById('clearLogsFilters');
        let logsCurrentPage = 1;
        const LOGS_PAGE_SIZE = 10;
        const debouncedLoadLogs = debounce((page) => loadFeedingLogs(page), 250);
        let logsFetchController = null;
        function buildLogsUrl(page) {
            const params = new URLSearchParams({ page: page, page_size: LOGS_PAGE_SIZE });
            if (logsStartDate && logsStartDate.value) params.set('start_date', logsStartDate.value);
            if (logsEndDate && logsEndDate.value) params.set('end_date', logsEndDate.value);
            return `/api/logs/?${params.toString()}`;
        }
        function getSourceLabel(source) {
            const src = (source || '').toLowerCase();
            if (src === 'schedule' || src === 'scheduled') return 'Schedule';
            if (src === 'manual_button' || src === 'button' || src === 'manual') return 'Manual Button';
            if (src === 'automatic_button' || src === 'remote_command' || src === 'web' || src === 'esp' || src === 'serial_command') return 'Automatic Button';
            return 'Manual Button';
        }
        function loadFeedingLogs(page = logsCurrentPage) {
            const url = buildLogsUrl(page);
            // Abort any in-flight logs request before starting a new one
            if (logsFetchController) {
                try { logsFetchController.abort(); } catch (_) {}
            }
            logsFetchController = new AbortController();
            fetch(url, { signal: logsFetchController.signal })
                .then(response => response.json())
                .then(data => {
                    logsList.innerHTML = '';
                    const results = Array.isArray(data) ? data : (data.results || []);
                    results.forEach(log => {
                        const row = document.createElement('tr');
                        const timestamp = new Date(log.timestamp).toLocaleString();
                        row.innerHTML = `
                            <td>${timestamp}</td>
                            <td>${log.portion_dispensed}g</td>
                            <td>${getSourceLabel(log.source)}</td>
                        `;
                        logsList.appendChild(row);
                    });
                    if (Array.isArray(data)) {
                        logsPrevBtn.disabled = true;
                        logsNextBtn.disabled = true;
                        logsPageInfo.textContent = `Total: ${data.length}`;
                    } else {
                        const totalCount = data.count || 0;
                        const hasPrev = !!data.previous;
                        const hasNext = !!data.next;
                        logsPrevBtn.disabled = !hasPrev;
                        logsNextBtn.disabled = !hasNext;
                        const totalPages = Math.max(1, Math.ceil(totalCount / LOGS_PAGE_SIZE));
                        logsPageInfo.textContent = `Page ${logsCurrentPage} of ${totalPages} (${totalCount} logs)`;
                    }
                })
                .catch(error => {
                    if (error && (error.name === 'AbortError' || (error instanceof TypeError && error.message === 'Failed to fetch'))) {
                        // Ignore aborted/preview reload fetch interruptions
                        return;
                    }
                    console.error('Logs fetch error:', error);
                });
        }

        applyLogsFiltersBtn.addEventListener('click', () => {
            logsCurrentPage = 1;
            debouncedLoadLogs(logsCurrentPage);
        });
        clearLogsFiltersBtn.addEventListener('click', () => {
            if (logsStartDate) logsStartDate.value = '';
            if (logsEndDate) logsEndDate.value = '';
            logsCurrentPage = 1;
            debouncedLoadLogs(logsCurrentPage);
        });

        logsPrevBtn.addEventListener('click', () => {
            if (logsCurrentPage > 1) {
                logsCurrentPage -= 1;
                debouncedLoadLogs(logsCurrentPage);
            }
        });
        logsNextBtn.addEventListener('click', () => {
            logsCurrentPage += 1;
            debouncedLoadLogs(logsCurrentPage);
        });

        // Dispatch a "Feed Now" command to the backend API
        feedNowBtn.addEventListener('click', () => {
            const portionSize = portionSlider.value;
            feedNowBtn.disabled = true;
            feedNowBtn.innerHTML = '<div><i class="fas fa-spinner fa-spin"></i><div>Feeding...</div></div>';
            fetch('/feed_now/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ portion_size: portionSize, device_id: (window.DEVICE_ID || '{{ DEVICE_ID }}') })
            })
            .then(async (response) => {
                let data = null;
                try { data = await response.json(); } catch (_) {}
                // Treat 409 Conflict (already pending) as a soft success
                if (response.status === 409) {
                    return Object.assign({ status: 'already_pending' }, data || {});
                }
                if (!response.ok) {
                    // If backend provided structured error, surface it
                    if (data && data.success === false) {
                        return data;
                    }
                    const msg = (data && (data.message || data.error || data.detail)) || `Request failed (${response.status})`;
                    throw new Error(msg);
                }
                return data;
            })
            .then(data => {
                // Explicit offline handling
                if (data && data.success === false) {
                    alert(data.error || 'Device not connected. Please check Wi-Fi or power.');
                    feedNowBtn.disabled = false;
                    feedNowBtn.innerHTML = '<div><i class="fas fa-utensils"></i><div>Feed Now</div></div>';
                    return;
                }
                if (data && (data.status === 'ok' || data.status === 'already_pending')) {
                    feedNowBtn.innerHTML = '<div><i class="fas fa-check"></i><div>Success!</div></div>';
                    const msg = (data.status === 'already_pending')
                      ? `Feed command already queued (command #${data.command_id || ''}).`
                      : `Successfully queued ${data.portion_size}g feed command.`;
                    showToast(msg, 'success');
                    setTimeout(() => {
                        feedNowBtn.disabled = false;
                        feedNowBtn.innerHTML = '<div><i class="fas fa-utensils"></i><div>Feed Now</div></div>';
                    }, 2000);
                    setTimeout(() => debouncedLoadLogs(logsCurrentPage), 2000);
                } else {
                    const msg = (data && (data.message || data.detail)) || 'Feed command not accepted.';
                    showToast(msg, 'danger');
                    feedNowBtn.disabled = false;
                    feedNowBtn.innerHTML = '<div><i class="fas fa-utensils"></i><div>Feed Now</div></div>';
                }
            })
            .catch(error => {
                console.error('Feed Now error:', error);
                feedNowBtn.disabled = false;
                feedNowBtn.innerHTML = '<div><i class="fas fa-utensils"></i><div>Feed Now</div></div>';
                alert('Server unreachable.');
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            debouncedLoadLogs(logsCurrentPage);
            loadSchedules();
            window._logsRefreshTimer = setInterval(() => debouncedLoadLogs(logsCurrentPage), 10000);
            document.addEventListener('visibilitychange', () => { if (!document.hidden) debouncedLoadLogs(logsCurrentPage); });
            window.addEventListener('focus', () => debouncedLoadLogs(logsCurrentPage));
        });
    </script>
</body>
</html>
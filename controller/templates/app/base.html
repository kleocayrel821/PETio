<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}PETio - Smart Pet Feeder{% endblock %}</title>
    
    <!-- DaisyUI + Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'clean-blue': '#3b82f6',
                        'clean-emerald': '#10b981',
                        'clean-amber': '#f59e0b',
                        'clean-slate': '#64748b',
                        'clean-gray': '#f8fafc'
                    }
                }
            },
            daisyui: {
                themes: [{
                    petio: {
                        "primary": "#3b82f6",
                        "secondary": "#10b981", 
                        "accent": "#f59e0b",
                        "neutral": "#64748b",
                        "base-100": "#ffffff",
                        "base-200": "#f8fafc",
                        "base-300": "#f1f5f9",
                        "base-content": "#1e293b",
                        "info": "#3b82f6",
                        "success": "#22c55e",
                        "warning": "#f97316",
                        "error": "#ef4444"
                    }
                }]
            }
        }
    </script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Custom CSS Variables and Enhancements -->
    <style>
        :root {
            /* Clean Light Color Palette */
            --primary-blue: #3b82f6;
            --accent-emerald: #10b981;
            --accent-amber: #f59e0b;
            --success-green: #22c55e;
            --warning-orange: #f97316;
            --error-red: #ef4444;
            
            /* Background Variations */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --bg-card-hover: #f1f5f9;
            
            /* Text Colors */
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            
            /* Shadows */
            --shadow-card: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-card-hover: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            
            /* Transitions */
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease-in-out;
        }
        
        /* Enhanced Body with Gradient Background */
        body {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: var(--transition-smooth);
        }
        
        /* Typography Hierarchy */
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .subsection-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }
        
        /* Enhanced Card Styling */
        .enhanced-card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow-card);
            padding: 1.5rem;
            transition: var(--transition-smooth);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .enhanced-card:hover {
            box-shadow: var(--shadow-card-hover);
            background: var(--bg-card-hover);
            transform: translateY(-2px);
        }
        
        /* Button Enhancements */
        .btn-enhanced {
            transition: var(--transition-fast);
            font-weight: 600;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-enhanced:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn-enhanced:active {
            transform: translateY(0);
        }
        
        /* Enhanced Microinteractions & Animations */
        
        /* Button Press Effects */
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-enhanced:active {
            transform: scale(0.96) translateY(1px);
        }
        
        /* Ripple Effect for Buttons */
        .btn-enhanced {
            position: relative;
            overflow: hidden;
        }
        
        .btn-enhanced::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-enhanced:active::before {
            width: 300px;
            height: 300px;
        }
        
        /* Enhanced Hover Animations */
        .enhanced-card {
            transition: all var(--transition-medium);
        }
        
        .enhanced-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }
        
        /* Form Control Focus Animations */
        .form-control-enhanced {
            position: relative;
            transition: all var(--transition-medium);
        }
        
        .form-control-enhanced:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }
        
        /* Loading Spinner Animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        /* Pulse Animation for Status Indicators */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* Bounce Animation for Success States */
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0,-8px,0); }
            70% { transform: translate3d(0,-4px,0); }
            90% { transform: translate3d(0,-2px,0); }
        }
        
        .bounce {
            animation: bounce 1s ease-in-out;
        }
        
        /* Shake Animation for Error States */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        
        .shake {
            animation: shake 0.6s ease-in-out;
        }
        
        /* Slide In Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .slide-in-up {
            animation: slideInUp 0.6s ease-out;
        }
        
        .slide-in-down {
            animation: slideInDown 0.6s ease-out;
        }
        
        .slide-in-left {
            animation: slideInLeft 0.6s ease-out;
        }
        
        .slide-in-right {
            animation: slideInRight 0.6s ease-out;
        }
        
        /* Fade In Animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        
        /* Scale In Animation */
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .scale-in {
            animation: scaleIn 0.5s ease-out;
        }
        
        /* Enhanced Toast Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
            pointer-events: none; /* Let clicks pass through when no toast is under the cursor */
        }
        
        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            transform: translateX(100%);
            opacity: 0;
            transition: all var(--transition-medium);
            position: relative;
            overflow: hidden;
            pointer-events: auto; /* Allow interaction with the toast itself */
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast.hide {
            transform: translateX(100%);
            opacity: 0;
        }
        
        .toast::before {
             content: '';
             position: absolute;
             left: 0;
             top: 0;
             bottom: 0;
             width: 4px;
             background: var(--primary-blue);
         }
        
        .toast.success::before {
            background: var(--success-green);
        }
        
        .toast.error::before {
            background: var(--error-red);
        }
        
        .toast.warning::before {
            background: var(--warning-orange);
        }
        
        .toast.info::before {
            background: var(--primary-blue);
        }
        
        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .toast.success .toast-icon {
            color: var(--success-green);
        }
        
        .toast.error .toast-icon {
            color: var(--error-red);
        }
        
        .toast.warning .toast-icon {
            color: var(--warning-orange);
        }
        
        .toast.info .toast-icon {
            color: var(--primary-blue);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        
        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition-fast);
            flex-shrink: 0;
        }
        
        .toast-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        /* Progress Bar for Toast Auto-dismiss */
        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            transition: width linear;
        }
        
        /* Navbar Hover Effects */
        .navbar-nav .nav-link {
            position: relative;
            transition: all var(--transition-fast);
        }
        
        .navbar-nav .nav-link::after {
             content: '';
             position: absolute;
             bottom: -2px;
             left: 50%;
             width: 0;
             height: 2px;
             background: var(--primary-blue);
             transition: all var(--transition-fast);
             transform: translateX(-50%);
         }
        
        .navbar-nav .nav-link:hover::after,
        .navbar-nav .nav-link.active::after {
            width: 100%;
        }
        
        .navbar-nav .nav-link:hover {
             color: var(--primary-blue) !important;
             transform: translateY(-1px);
         }
        
        /* Table Row Hover Effects */
        .enhanced-table tbody tr {
            transition: all var(--transition-fast);
        }
        
        .enhanced-table tbody tr:hover {
            background: var(--bg-card-hover);
            transform: translateX(4px);
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Status Badge Animations */
        .status-badge {
            transition: all var(--transition-fast);
        }
        
        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        /* Loading States */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-medium);
            pointer-events: none; /* Prevent overlay from blocking clicks (nav stays clickable) */
        }
        
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            pointer-events: auto; /* Allow interaction with content inside overlay if needed */
        }
        
        /* Stagger Animation for Lists */
        .stagger-item {
            opacity: 0;
            transform: translateY(20px);
            animation: staggerIn 0.6s ease-out forwards;
        }
        
        @keyframes staggerIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .stagger-item:nth-child(1) { animation-delay: 0.1s; }
        .stagger-item:nth-child(2) { animation-delay: 0.2s; }
        .stagger-item:nth-child(3) { animation-delay: 0.3s; }
        .stagger-item:nth-child(4) { animation-delay: 0.4s; }
        .stagger-item:nth-child(5) { animation-delay: 0.5s; }
        .stagger-item:nth-child(6) { animation-delay: 0.6s; }
        .stagger-item:nth-child(7) { animation-delay: 0.7s; }
        .stagger-item:nth-child(8) { animation-delay: 0.8s; }
        
        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Focus Visible for Accessibility */
        .btn:focus-visible,
         .form-control-enhanced:focus-visible {
             outline: 2px solid var(--primary-blue);
             outline-offset: 2px;
         }
        
        /* Reduced Motion Support */
         @media (prefers-reduced-motion: reduce) {
             *,
             *::before,
             *::after {
                 animation-duration: 0.01ms !important;
                 animation-iteration-count: 1 !important;
                 transition-duration: 0.01ms !important;
             }
         }
         
         /* Accent Button Variants */
          .btn-primary-enhanced {
              background: linear-gradient(135deg, var(--primary-blue), #2563eb);
              border: none;
              color: white;
          }
          
          .btn-primary-enhanced:hover {
              background: linear-gradient(135deg, #2563eb, var(--primary-blue));
          }
          
          .btn-accent-teal {
              background: linear-gradient(135deg, var(--accent-emerald), #059669);
              border: none;
              color: white;
          }
          
          .btn-accent-orange {
              background: linear-gradient(135deg, var(--warning-orange), #ea580c);
              border: none;
              color: white;
          }
         
         /* Table Enhancements */
         .enhanced-table {
             background: var(--bg-card);
             border-radius: 12px;
             overflow: hidden;
             box-shadow: var(--shadow-card);
         }
         
         .enhanced-table th {
             background: var(--bg-secondary);
             color: var(--text-primary);
             font-weight: 600;
             padding: 1rem;
             border-bottom: 2px solid rgba(255, 255, 255, 0.1);
         }
         
         .enhanced-table td {
             padding: 0.75rem 1rem;
             border-bottom: 1px solid rgba(255, 255, 255, 0.05);
             transition: var(--transition-fast);
         }
         
         .enhanced-table tbody tr:hover {
             background: rgba(255, 255, 255, 0.05);
         }
         
         .enhanced-table tbody tr:nth-child(even) {
             background: rgba(255, 255, 255, 0.02);
         }
         
         /* Form Enhancements */
         .form-control-enhanced {
             background: var(--bg-secondary);
             border: 2px solid rgba(255, 255, 255, 0.1);
             border-radius: 8px;
             color: var(--text-primary);
             transition: var(--transition-fast);
             padding: 0.75rem;
         }
         
         .form-control-enhanced:focus {
              border-color: var(--primary-blue);
              box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
              outline: none;
          }
         
         /* Status Badges */
         .status-badge {
             display: inline-flex;
             align-items: center;
             gap: 0.25rem;
             padding: 0.25rem 0.75rem;
             border-radius: 9999px;
             font-size: 0.875rem;
             font-weight: 500;
         }
         
         .status-enabled {
             background: rgba(16, 185, 129, 0.2);
             color: var(--success-green);
             border: 1px solid rgba(16, 185, 129, 0.3);
         }
         
         .status-disabled {
             background: rgba(156, 163, 175, 0.2);
             color: var(--text-muted);
             border: 1px solid rgba(156, 163, 175, 0.3);
         }
         
         /* Navbar Enhancements */
         .navbar-enhanced {
             background: rgba(31, 41, 55, 0.95);
             backdrop-filter: blur(10px);
             border-bottom: 1px solid rgba(255, 255, 255, 0.1);
             z-index: 10010 !important; /* Keep navbar above overlays and toasts */
         }
         
         .navbar-enhanced .navbar-brand {
              font-weight: 700;
              font-size: 1.25rem;
              color: var(--primary-blue);
          }
         
         .navbar-enhanced .nav-link {
             color: var(--text-secondary);
             transition: var(--transition-fast);
             padding: 0.5rem 1rem;
             border-radius: 6px;
         }
         
         .navbar-enhanced .nav-link:hover {
             color: var(--text-primary);
             background: rgba(255, 255, 255, 0.1);
         }
         
         .navbar-enhanced .nav-link.active {
              color: var(--primary-blue);
              background: rgba(59, 130, 246, 0.1);
          }
         
         /* Responsive Grid */
         .responsive-grid {
             display: grid;
             gap: 1.5rem;
             grid-template-columns: 1fr;
         }
         
         @media (min-width: 768px) {
             .responsive-grid {
                 grid-template-columns: repeat(2, 1fr);
             }
         }
         
         /* Slider Enhancements */
         .range-enhanced {
             appearance: none;
             background: var(--bg-secondary);
             height: 8px;
             border-radius: 4px;
             outline: none;
             transition: var(--transition-fast);
         }
         
         .range-enhanced::-webkit-slider-thumb {
              appearance: none;
              width: 20px;
              height: 20px;
              border-radius: 50%;
              background: var(--primary-blue);
              cursor: pointer;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
              transition: var(--transition-fast);
          }
         
         .range-enhanced::-webkit-slider-thumb:hover {
             transform: scale(1.1);
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
         }
         
         /* Pagination Enhancements */
         .pagination-enhanced .btn {
             margin: 0 0.125rem;
             border-radius: 6px;
             transition: var(--transition-fast);
         }
         
         .pagination-enhanced .btn:hover {
             transform: translateY(-1px);
         }
     </style>
</head>
<body>
     <!-- System-wide Navigation Drawer -->
     <div class="drawer lg:drawer-open">
         <input id="system-drawer-toggle" type="checkbox" class="drawer-toggle" />
         
         <!-- Main Content Wrapper -->
         <div class="drawer-content flex flex-col">
             <!-- Enhanced Navbar -->
             <nav class="navbar navbar-enhanced sticky top-0 z-40 lg:pl-4">
             <div class="navbar-start">
                 <!-- System Drawer Toggle for Mobile -->
                 <label for="system-drawer-toggle" class="btn btn-ghost lg:hidden mr-2" aria-label="Open system navigation">
                     <i class="fas fa-bars text-lg"></i>
                 </label>
             </div>
             <!-- App-specific navbar goes here -->
             <div class="navbar-center">
               {% block app_nav %}{% endblock %}
             </div>
             <!-- Hide device status on the right -->
             <div class="navbar-end hidden"></div>
             </nav>

<style>
/***** Navbar mobile enhancements *****/
/* Hide horizontal scrollbar visuals on supported browsers while allowing scroll */
.navbar .menu::-webkit-scrollbar { display: none; }
.navbar .menu { -ms-overflow-style: none; scrollbar-width: none; }
</style>



            <!-- Main Content -->
            <main class="container mx-auto px-4 py-6 {% if request.resolver_match and request.resolver_match.namespace != 'marketplace' %}pb-[calc(4.5rem+env(safe-area-inset-bottom))] {% endif %}lg:pb-6">
                {% block content %}
                {% endblock %}
            </main>
         </div>
         
         <!-- System Navigation Sidebar -->
         <div class="drawer-side">
             <label for="system-drawer-toggle" aria-label="Close system navigation" class="drawer-overlay"></label>
             <aside class="min-h-full w-80 bg-base-200 text-base-content flex flex-col">
                 <!-- Sidebar Header -->
                 <div class="p-4 border-b border-base-300">
                     <div class="flex items-center gap-3">
                         <div class="avatar placeholder">
                             <div class="bg-primary text-primary-content rounded-full w-10">
                                 <span class="text-lg"><i class="fas fa-paw"></i></span>
                             </div>
                         </div>
                         <div>
                             <h2 class="font-bold text-lg">PETio System</h2>
                             <p class="text-sm opacity-70">IoT Pet Feeder</p>
                         </div>
                     </div>
                 </div>
                 
                 <!-- Navigation Menu -->
                 <nav class="flex-1 p-4">
                     <ul class="menu menu-lg w-full">
                         <li class="menu-title">
                             <span>Applications</span>
                         </li>
                         <li>
                             <a href="/" class="flex items-center gap-3 p-3 rounded-lg hover:bg-base-300 transition-colors">
                                 <i class="fas fa-gamepad text-primary text-xl"></i>
                                 <div>
                                     <div class="font-semibold">Controller</div>
                                     <div class="text-sm opacity-70">Feed & Schedule Management</div>
                                 </div>
                             </a>
                         </li>
                         <li>
                             <a href="/social/" class="flex items-center gap-3 p-3 rounded-lg hover:bg-base-300 transition-colors">
                                 <i class="fas fa-users text-secondary text-xl"></i>
                                 <div>
                                     <div class="font-semibold">Social</div>
                                     <div class="text-sm opacity-70">Community & Sharing</div>
                                 </div>
                             </a>
                         </li>
                         <li>
                             <a href="/marketplace/" class="flex items-center gap-3 p-3 rounded-lg hover:bg-base-300 transition-colors">
                                 <i class="fas fa-store text-accent text-xl"></i>
                                 <div>
                                     <div class="font-semibold">Marketplace</div>
                                     <div class="text-sm opacity-70">Products & Services</div>
                                 </div>
                             </a>
                         </li>
                     </ul>
                 </nav>
                 
                 <!-- Sidebar Footer -->
                <div class="p-4 border-t border-base-300">
                    <form method="post" action="{% url 'logout' %}" class="btn btn-ghost btn-block justify-start gap-3">
                        {% csrf_token %}
                        <button type="submit" class="flex items-center gap-3 w-full justify-start text-left">
                            <i class="fas fa-sign-out-alt text-error"></i>
                            <span>Logout</span>
                        </button>
                    </form>
                </div>
             </aside>
         </div>
     </div>

     <!-- Toast Container -->
     <div class="toast-container" id="toastContainer"></div>

     <!-- Enhanced JavaScript -->
     <script>
         // CSRF Token Helper
         function getCookie(name) {
             let cookieValue = null;
             if (document.cookie && document.cookie !== '') {
                 const cookies = document.cookie.split(';');
                 for (let i = 0; i < cookies.length; i++) {
                     const cookie = cookies[i].trim();
                     if (cookie.substring(0, name.length + 1) === (name + '=')) {
                         cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                         break;
                     }
                 }
             }
             return cookieValue;
         }

         // Enhanced Toast System
        class ToastManager {
            constructor() {
                this.container = this.createContainer();
                this.toasts = new Map();
                this.toastId = 0;
            }
            
            createContainer() {
                let container = document.querySelector('.toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.className = 'toast-container';
                    document.body.appendChild(container);
                }
                return container;
            }
            
            show(message, type = 'info', options = {}) {
                const id = ++this.toastId;
                const toast = this.createToast(id, message, type, options);
                
                this.container.appendChild(toast);
                this.toasts.set(id, toast);
                
                // Trigger show animation
                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });
                
                // Auto dismiss
                if (options.autoDismiss !== false) {
                    const duration = options.duration || this.getDefaultDuration(type);
                    this.startProgressBar(toast, duration);
                    setTimeout(() => this.hide(id), duration);
                }
                
                return id;
            }
            
            createToast(id, message, type, options) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.dataset.toastId = id;
                
                const icon = this.getIcon(type);
                const title = options.title || this.getDefaultTitle(type);
                
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas fa-${icon}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="toastManager.hide(${id})">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="toast-progress"></div>
                `;
                
                return toast;
            }
            
            hide(id) {
                const toast = this.toasts.get(id);
                if (!toast) return;
                
                toast.classList.add('hide');
                toast.classList.remove('show');
                
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                    this.toasts.delete(id);
                }, 300);
            }
            
            startProgressBar(toast, duration) {
                const progressBar = toast.querySelector('.toast-progress');
                if (progressBar) {
                    progressBar.style.width = '100%';
                    progressBar.style.transitionDuration = `${duration}ms`;
                    requestAnimationFrame(() => {
                        progressBar.style.width = '0%';
                    });
                }
            }
            
            getIcon(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-triangle',
                    warning: 'exclamation-circle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            }
            
            getDefaultTitle(type) {
                const titles = {
                    success: 'Success',
                    error: 'Error',
                    warning: 'Warning',
                    info: 'Information'
                };
                return titles[type] || 'Notification';
            }
            
            getDefaultDuration(type) {
                const durations = {
                    success: 4000,
                    error: 6000,
                    warning: 5000,
                    info: 4000
                };
                return durations[type] || 4000;
            }
            
            // Convenience methods
            success(message, options = {}) {
                return this.show(message, 'success', options);
            }
            
            error(message, options = {}) {
                return this.show(message, 'error', options);
            }
            
            warning(message, options = {}) {
                return this.show(message, 'warning', options);
            }
            
            info(message, options = {}) {
                return this.show(message, 'info', options);
            }
        }
        
        // Initialize global toast manager
        const toastManager = new ToastManager();
        
        // Enhanced Loading States
        function showLoading(element, message = 'Loading...') {
            if (!element) return;
            
            element.style.position = 'relative';
            
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay show';
            overlay.innerHTML = `
                <div class="loading-content">
                    <i class="fas fa-spinner loading-spinner text-purple-400 text-2xl mb-2"></i>
                    <div class="text-gray-400">${message}</div>
                </div>
            `;
            
            element.appendChild(overlay);
            return overlay;
        }
        
        function hideLoading(element) {
            if (!element) return;
            
            const overlay = element.querySelector('.loading-overlay');
            if (overlay) {
                overlay.classList.remove('show');
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 300);
            }
        }
        
        // Enhanced Button States
        function setButtonLoading(button, loading = true) {
            if (!button) return;
            
            if (loading) {
                button.disabled = true;
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner loading-spinner mr-2"></i>Loading...';
                button.classList.add('loading');
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText || button.innerHTML;
                button.classList.remove('loading');
            }
        }
        
        // Animation Utilities
        function animateElement(element, animation, duration = 600) {
            return new Promise((resolve) => {
                element.style.animationDuration = `${duration}ms`;
                element.classList.add(animation);
                
                const handleAnimationEnd = () => {
                    element.classList.remove(animation);
                    element.removeEventListener('animationend', handleAnimationEnd);
                    resolve();
                };
                
                element.addEventListener('animationend', handleAnimationEnd);
            });
        }
        
        // Stagger Animation for Lists
        function staggerAnimate(elements, delay = 100) {
            elements.forEach((element, index) => {
                setTimeout(() => {
                    element.classList.add('stagger-item');
                }, index * delay);
            });
        }
        
        // Enhanced Form Validation with Animations
        function showFieldError(field, message) {
            field.classList.add('shake');
            field.style.borderColor = 'var(--error-red)';
            
            // Remove existing error message
            const existingError = field.parentNode.querySelector('.field-error');
            if (existingError) {
                existingError.remove();
            }
            
            // Add new error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'field-error text-red-400 text-sm mt-1 slide-in-up';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
            
            // Remove shake animation after it completes
            setTimeout(() => {
                field.classList.remove('shake');
            }, 600);
        }
        
        function clearFieldError(field) {
            field.style.borderColor = '';
            const errorDiv = field.parentNode.querySelector('.field-error');
            if (errorDiv) {
                errorDiv.classList.add('slide-out-up');
                setTimeout(() => errorDiv.remove(), 300);
            }
        }
        
        // Smooth Scroll to Element
        function scrollToElement(element, offset = 0) {
            if (!element) return;
            
            const elementPosition = element.getBoundingClientRect().top + window.pageYOffset;
            const offsetPosition = elementPosition - offset;
            
            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        }
        
        // Enhanced Navigation Active State
        function updateActiveNavigation() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
        }
        
        // Initialize animations on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Update navigation
            updateActiveNavigation();
            
            // Add stagger animation to cards
            const cards = document.querySelectorAll('.enhanced-card');
            staggerAnimate(cards, 150);
            
            // Add fade-in animation to main content
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.classList.add('fade-in');
            }
            
            // Enhanced form interactions
            const formControls = document.querySelectorAll('.form-control-enhanced');
            formControls.forEach(control => {
                control.addEventListener('focus', function() {
                    this.parentNode.classList.add('focused');
                });
                
                control.addEventListener('blur', function() {
                    this.parentNode.classList.remove('focused');
                    if (this.value) {
                        this.parentNode.classList.add('has-value');
                    } else {
                        this.parentNode.classList.remove('has-value');
                    }
                });
            });
            
            // Add ripple effect to buttons
            const buttons = document.querySelectorAll('.btn-enhanced');
            buttons.forEach(button => {
                button.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';
                    ripple.classList.add('ripple');
                    
                    this.appendChild(ripple);
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });
        });
        
        // Global error handler with toast notifications
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            toastManager.error('An unexpected error occurred. Please try again.');
        });
        
        // Global unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            toastManager.error('A network error occurred. Please check your connection.');
        });
    </script>
<script>
// Controller realtime + error handling + retry (Phase 1)
(function() {
  if (window.__petioRealtimeInit) return; // avoid duplication
  window.__petioRealtimeInit = true;

  const STATUS_ENDPOINT = '/api/device-status/';
  const DEVICE_ID = '{{ DEVICE_ID }}';
  const statusIcon = document.getElementById('device-status-icon');
  const statusText = document.getElementById('device-status-text');
  const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const WS_DEVICE_STATUS_URL = wsProtocol + '://' + window.location.host + '/ws/device-status/';
  const WS_FEEDING_LOGS_URL = wsProtocol + '://' + window.location.host + '/ws/feeding-logs/';

  // Navbar indicator updater
  function updateIndicator(status) {
    if (!statusIcon || !statusText) return;
    statusIcon.classList.remove('text-green-400', 'text-red-400', 'text-gray-400');
    switch (status) {
      case 'online':
        statusIcon.classList.add('text-green-400');
        statusText.textContent = 'Connected';
        break;
      case 'offline':
        statusIcon.classList.add('text-red-400');
        statusText.textContent = 'Offline';
        break;
      default:
        statusIcon.classList.add('text-gray-400');
        statusText.textContent = 'Unknown';
        break;
    }
  }

  // Reusable fetch with exponential backoff (1s, 2s, 4s)
  if (!window.fetchWithRetry) {
    window.fetchWithRetry = async function(url, options = {}, retries = 3) {
      const headers = options.headers || {};
      if (!('X-CSRFToken' in headers) && typeof getCookie === 'function') {
        headers['X-CSRFToken'] = getCookie('csrftoken') || '';
      }
      options.headers = headers;
      const backoffs = [1000, 2000, 4000];
      for (let attempt = 0; attempt < retries; attempt++) {
        try {
          const res = await fetch(url, options);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res;
        } catch (err) {
          if (attempt === retries - 1) throw err;
          await new Promise(r => setTimeout(r, backoffs[attempt] || backoffs[backoffs.length - 1]));
        }
      }
    }
  }

  // ErrorBoundary: capture window errors and rejections; report only (toast already handled globally)
  class ErrorBoundary {
    constructor(endpoint) { this.endpoint = endpoint; this.install(); }
    install() {
      window.addEventListener('error', e => {
        this.report({ type: 'error', message: e.message || e.error?.message || 'Unknown error', stack: e.error?.stack || null });
      });
      window.addEventListener('unhandledrejection', e => {
        const msg = e.reason?.message || String(e.reason || 'Unhandled rejection');
        this.report({ type: 'unhandledrejection', message: msg, stack: e.reason?.stack || null });
      });
    }
    async report(payload) {
      try {
        await window.fetchWithRetry('/api/client-errors/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            timestamp: new Date().toISOString(),
            url: window.location.href,
            userAgent: navigator.userAgent,
            ...payload,
          })
        }, 3);
      } catch (err) {
        console.warn('ErrorBoundary: failed to report', err);
      }
    }
  }
  if (!window.__petioErrorBoundary) {
    window.__petioErrorBoundary = new ErrorBoundary('/api/client-errors/');
  }

  // HTTP polling fallback (used when WebSocket unavailable or disconnected)
  async function pollStatus() {
    try {
      const res = await window.fetchWithRetry(STATUS_ENDPOINT + '?device_id=' + encodeURIComponent(DEVICE_ID), {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      }, 3);
      const data = await res.json();
      const status = data?.status === 'online' ? 'online' : (data?.status === 'offline' ? 'offline' : 'unknown');
      updateIndicator(status);
    } catch (e) {
      updateIndicator('unknown');
    }
  }

  // Device status realtime via WebSocket
  function connectDeviceStatusWS() {
    if (!('WebSocket' in window)) {
      console.log('WebSocket not supported; falling back to polling.');
      return;
    }
    let socket = new WebSocket(WS_DEVICE_STATUS_URL);
    socket.addEventListener('open', () => { window.__deviceStatusWSConnected = true; });
    socket.addEventListener('message', (event) => {
      try {
        const data = JSON.parse(event.data);
        const s = data?.status === 'online' ? 'online' : (data?.status === 'offline' ? 'offline' : 'unknown');
        updateIndicator(s);
      } catch (err) {
        console.warn('DeviceStatus WS parse error', err);
      }
    });
    socket.addEventListener('close', () => {
      window.__deviceStatusWSConnected = false;
      setTimeout(connectDeviceStatusWS, 3000);
    });
    socket.addEventListener('error', (e) => {
      console.warn('DeviceStatus WS error', e);
      try { socket.close(); } catch (_) {}
    });
  }

  // Feeding logs realtime via WebSocket
  function connectFeedingLogsWS() {
    if (!('WebSocket' in window)) return;
    let socket = new WebSocket(WS_FEEDING_LOGS_URL);
    socket.addEventListener('message', (event) => {
      try {
        const data = JSON.parse(event.data);
        const portion = data?.amount ?? data?.portion_dispensed ?? 0;
        const feedType = data?.feed_type ?? data?.source ?? 'feed';
        const success = data?.success ?? (portion > 0);
        const deviceId = data?.device_id ?? DEVICE_ID;
        const ts = data?.timestamp ? new Date(data.timestamp).toLocaleString() : '';
        if (typeof toastManager !== 'undefined') {
          if (success) toastManager.success(`Feeding complete: ${portion}g via ${feedType} ${ts ? '(' + ts + ')' : ''}`);
          else toastManager.error(`Feeding failed via ${feedType}. Check device ${deviceId}`);
        } else {
          console.log('Feeding event', data);
        }
        const evt = new CustomEvent('feeding-log-event', { detail: data });
        window.dispatchEvent(evt);
      } catch (err) {
        console.warn('FeedingLogs WS parse error', err);
      }
    });
    socket.addEventListener('close', () => { setTimeout(connectFeedingLogsWS, 5000); });
    socket.addEventListener('error', (e) => { console.warn('FeedingLogs WS error', e); try { socket.close(); } catch (_) {} });
  }

  document.addEventListener('DOMContentLoaded', function() {
    connectDeviceStatusWS();
    connectFeedingLogsWS();
    // Initial poll and then every 30s as fallback
    pollStatus();
    setInterval(function() { if (!window.__deviceStatusWSConnected) pollStatus(); }, 30000);
    
    // Ensure service worker registration still functions (registered elsewhere or here)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistration().then(reg => {
        if (!reg) {
          navigator.serviceWorker.register('/sw.js').catch(err => console.warn('SW registration failed', err));
        }
      }).catch(() => {
        navigator.serviceWorker.register('/sw.js').catch(err => console.warn('SW registration failed', err));
      });
    }
  });
})();

// System Drawer Accessibility and Interaction
(function() {
  const drawerToggle = document.getElementById('system-drawer-toggle');
  const drawerOverlay = document.querySelector('.drawer-overlay');
  const sidebar = document.querySelector('.drawer-side aside');

  // Ensure the overlay never blocks clicks when drawer is closed
  function syncOverlayPointerEvents() {
    if (!drawerOverlay) return;
    const isOpen = !!(drawerToggle && drawerToggle.checked);
    drawerOverlay.style.pointerEvents = isOpen ? 'auto' : 'none';
  }
  // Initial state
  syncOverlayPointerEvents();
  // React to drawer toggle changes
  if (drawerToggle) {
    drawerToggle.addEventListener('change', syncOverlayPointerEvents);
  }
  
  // ESC key to close drawer
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && drawerToggle && drawerToggle.checked) {
      drawerToggle.checked = false;
      // Return focus to the toggle button
      const toggleButton = document.querySelector('label[for="system-drawer-toggle"]');
      if (toggleButton) {
        toggleButton.focus();
      }
      // Update overlay pointer-events after closing
      syncOverlayPointerEvents();
    }
  });
  
  // Focus trapping within drawer when open
  function trapFocus(element) {
    const focusableElements = element.querySelectorAll(
      'a[href], button, textarea, input[type="text"], input[type="radio"], input[type="checkbox"], select'
    );
    const firstFocusableElement = focusableElements[0];
    const lastFocusableElement = focusableElements[focusableElements.length - 1];
    
    element.addEventListener('keydown', function(e) {
      if (e.key === 'Tab') {
        if (e.shiftKey) {
          if (document.activeElement === firstFocusableElement) {
            lastFocusableElement.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === lastFocusableElement) {
            firstFocusableElement.focus();
            e.preventDefault();
          }
        }
      }
    });
  }
  
  // Initialize focus trapping when drawer opens
  if (drawerToggle && sidebar) {
    drawerToggle.addEventListener('change', function() {
      if (this.checked) {
        // Drawer opened - focus first link and enable focus trapping
        setTimeout(() => {
          const firstLink = sidebar.querySelector('a[href]');
          if (firstLink) {
            firstLink.focus();
          }
        }, 100);
        trapFocus(sidebar);
      }
    });
  }
  
  // Close drawer when clicking overlay
  if (drawerOverlay) {
    drawerOverlay.addEventListener('click', function() {
      if (drawerToggle) {
        drawerToggle.checked = false;
      }
    });
  }
  
  // Active app highlighting
  function highlightActiveApp() {
    const currentPath = window.location.pathname;
    const appLinks = sidebar?.querySelectorAll('nav a[href]');
    
    if (appLinks) {
      appLinks.forEach(link => {
        link.classList.remove('active');
        const href = link.getAttribute('href');
        
        // Controller app (home page and main paths)
        if (href === '/' && (currentPath === '/' || currentPath.startsWith('/schedules') || currentPath.startsWith('/history'))) {
          link.classList.add('active');
        }
        // Social app
        else if (href === '/social/' && currentPath.startsWith('/social')) {
          link.classList.add('active');
        }
        // Marketplace app
        else if (href === '/marketplace/' && currentPath.startsWith('/marketplace')) {
          link.classList.add('active');
        }
      });
    }
  }
  
  // Highlight active app on page load
  document.addEventListener('DOMContentLoaded', highlightActiveApp);
})();
</script>

<!-- Mobile Bottom Tab Bar (Option A) -->
{% load static %}
{% if request.resolver_match and request.resolver_match.namespace != 'marketplace' %}
{% with url_name=request.resolver_match.url_name %}
<div id="mobile-tab-bar" class="btm-nav fixed bottom-0 left-0 right-0 z-50 bg-base-100 border-t border-base-300 lg:hidden">
  <a href="/" class="{% if url_name == 'home' %}active{% endif %}" aria-label="Home">
    <i class="fas fa-home"></i>
    <span class="btm-nav-label">Home</span>
  </a>
  <!-- Feed tab removed (redundant) -->
  <a href="/schedules-ui/" class="{% if url_name == 'schedules_ui' %}active{% endif %}" aria-label="Schedules">
    <i class="fas fa-calendar-alt"></i>
    <span class="btm-nav-label">Schedules</span>
  </a>
  <a href="/history/" class="{% if url_name == 'history' %}active{% endif %}" aria-label="History">
    <i class="fas fa-history"></i>
    <span class="btm-nav-label">History</span>
  </a>
</div>
{% endwith %}
{% endif %}

<style>
/* Mobile Bottom Tab Bar styling and safe-area support */
@media (max-width: 1024px) {
  #mobile-tab-bar { padding-bottom: env(safe-area-inset-bottom); }
}
</style>
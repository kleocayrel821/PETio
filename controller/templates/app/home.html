{% extends "base.html" %}

{% block title %}Home - PETio{% endblock %}

{% block sidebar %}
  {% include "controller/sidebar.html" with view_name="home" %}
{% endblock %}

{% block app_nav %}
<ul class="menu menu-horizontal px-1 gap-1 overflow-x-auto">
  <li>
    <a href="{% url 'home' %}" class="{% if request.resolver_match and request.resolver_match.url_name == 'home' %}active{% endif %}">
      <i class="fas fa-home mr-2"></i>
      <span>Home</span>
    </a>
  </li>
  <li>
    <a href="{% url 'schedules_ui' %}" class="{% if request.resolver_match and request.resolver_match.url_name == 'schedules_ui' %}active{% endif %}">
      <i class="fas fa-calendar-alt mr-2"></i>
      <span>Schedules</span>
    </a>
  </li>
  <li>
    <a href="{% url 'history' %}" class="{% if request.resolver_match and request.resolver_match.url_name == 'history' %}active{% endif %}">
      <i class="fas fa-history mr-2"></i>
      <span>History</span>
    </a>
  </li>
</ul>
{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Welcome Header -->
    <!-- <div class="text-center">
        <h1 class="section-title justify-center text-3xl mb-2">
            <i class="fas fa-home text-[#1f456e]"></i>
            Welcome to PETio
        </h1>
        <p class="text-gray-400 text-lg">Your smart pet feeding companion</p>
    </div> -->

    <!-- Main Control Grid -->
    <div class="responsive-grid">
        <!-- Feed Now Card -->
        <div class="enhanced-card">
            <div class="section-title">
                <i class="fas fa-utensils text-[#1f456e]"></i>
                Feed Now
            </div>
            <div class="space-y-4">
                <!-- Portion Size Control -->
                <div>
                    <label class="subsection-title flex items-center gap-2">
                        <i class="fas fa-balance-scale text-teal-400"></i>
                        Portion Size: <span id="portionDisplay" class="text-[#1f456e] font-bold">25 grams</span>
                    </label>
                    <div class="relative">
                        <input 
                            type="range" 
                            id="portionSlider" 
                            class="range-enhanced w-full" 
                            min="25" 
                            max="500" 
                            value="25"
                            oninput="updatePortionDisplay(this.value)"
                        >
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>25g</span>
                            <span>250g</span>
                            <span>500g</span>
                        </div>
                    </div>
                </div>

                <!-- Feed Button -->
                <button 
                    id="feedNowBtn" 
                    class="btn btn-enhanced btn-accent-orange w-full text-lg py-3"
                    onclick="feedNow()"
                >
                    <i class="fas fa-paw"></i>
                    Feed Now
                </button>

                <!-- Last Fed Info -->
                <div class="bg-gray-800 rounded-lg p-3 text-center">
                    <div class="text-sm text-gray-400">Last Fed</div>
                    <div id="lastFedTime" class="text-white font-semibold">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Quick Schedule Card -->
        <div class="enhanced-card">
            <div class="section-title">
                <i class="fas fa-clock text-[#1f456e]"></i>
                Quick Schedule
            </div>
            <form id="quickScheduleForm" class="space-y-4">
                <!-- Time Input -->
                <div>
                    <label class="subsection-title">
                        <i class="fas fa-time text-[#1f456e]"></i>
                        Feeding Time
                    </label>
                    <input 
                        type="time" 
                        id="scheduleTime" 
                        class="form-control-enhanced w-full"
                        required
                    >
                </div>

                <!-- Amount Input -->
                <div>
                    <label class="subsection-title">
                        <i class="fas fa-weight text-orange-400"></i>
                        Amount (grams)
                    </label>
                    <input 
                        type="number" 
                        id="scheduleAmount" 
                        class="form-control-enhanced w-full"
                        min="25" 
                        max="500" 
                        value="25"
                        required
                    >
                </div>

                <!-- Days Selection -->
                <div>
                    <label class="subsection-title">
                        <i class="fas fa-calendar text-green-400"></i>
                        Days
                    </label>
                    <div class="grid grid-cols-4 sm:grid-cols-7 gap-1">
                        <label class="day-toggle">
                            <input type="checkbox" name="days" value="monday" class="hidden">
                            <span class="day-label">M</span>
                        </label>
                        <label class="day-toggle">
                            <input type="checkbox" name="days" value="tuesday" class="hidden">
                            <span class="day-label">T</span>
                        </label>
                        <label class="day-toggle">
                            <input type="checkbox" name="days" value="wednesday" class="hidden">
                            <span class="day-label">W</span>
                        </label>
                        <label class="day-toggle">
                            <input type="checkbox" name="days" value="thursday" class="hidden">
                            <span class="day-label">T</span>
                        </label>
                        <label class="day-toggle">
                            <input type="checkbox" name="days" value="friday" class="hidden">
                            <span class="day-label">F</span>
                        </label>
                        <label class="day-toggle">
                            <input type="checkbox" name="days" value="saturday" class="hidden">
                            <span class="day-label">S</span>
                        </label>
                        <label class="day-toggle">
                            <input type="checkbox" name="days" value="sunday" class="hidden">
                            <span class="day-label">S</span>
                        </label>
                    </div>
                </div>

                <!-- Add Schedule Button -->
                <button 
                    type="submit" 
                    class="btn btn-enhanced btn-primary-enhanced w-full"
                >
                    <i class="fas fa-plus"></i>
                    Add Schedule
                </button>
            </form>
        </div>
    </div>

    <!-- Recent Activity Card -->
    <div class="enhanced-card">
        <div class="section-title">
            <i class="fas fa-history text-[#1f456e]"></i>
            Recent Activity
        </div>
        <div class="overflow-x-auto">
            <table class="enhanced-table w-full">
                <thead>
                    <tr>
                        <th><i class="fas fa-clock mr-2"></i>Time</th>
                        <th><i class="fas fa-info-circle mr-2"></i>Action</th>
                        <th><i class="fas fa-weight mr-2"></i>Amount</th>
                        <th><i class="fas fa-check-circle mr-2"></i>Status</th>
                    </tr>
                </thead>
                <tbody id="recentActivityTable">
                    <tr>
                        <td colspan="4" class="text-center text-gray-400 py-8">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            Loading recent activity...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="mt-4 text-center">
            <a href="/history/" class="btn btn-enhanced btn-ghost">
                <i class="fas fa-external-link-alt"></i>
                View Full History
            </a>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="enhanced-card text-center">
            <div class="text-2xl font-bold text-[#1f456e]" id="todayFeedings">-</div>
            <div class="text-sm text-gray-400">Today's Feedings</div>
        </div>
        <div class="enhanced-card text-center">
            <div class="text-2xl font-bold text-teal-400" id="activeSchedules">-</div>
            <div class="text-sm text-gray-400">Active Schedules</div>
        </div>
        <div class="enhanced-card text-center">
            <div class="text-2xl font-bold text-orange-400" id="totalAmount">-</div>
            <div class="text-sm text-gray-400">Total Amount Today</div>
        </div>
    </div>
</div>

<style>
/* Controller Feed Now & Quick Schedule icon color overrides */
.section-title .fa-utensils { color: #1f456e !important; }
.section-title .fa-clock { color: #1f456e !important; }
.section-title .fa-history { color: #1f456e !important; }
/* Day Toggle Styling */
.day-toggle {
    cursor: pointer;
}

.day-label {
    display: block;
    text-align: center;
    padding: 0.5rem;
    border-radius: 6px;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.875rem;
    transition: var(--transition-fast);
    border: 2px solid transparent;
}

.day-toggle:hover .day-label {
    background: var(--bg-card-hover);
    color: var(--text-primary);
}

.day-toggle input:checked + .day-label {
    background: #1f456e;
    color: white;
    border-color: rgba(31, 69, 110, 0.5);
    box-shadow: 0 0 0 2px rgba(31, 69, 110, 0.2);
}

/* Progress Bar for Portion Slider */
.range-enhanced {
    background: linear-gradient(to right, #1f456e 0%, #1f456e 25%, var(--bg-secondary) 25%, var(--bg-secondary) 100%);
    accent-color: #1f456e;
}
.range-enhanced::-webkit-slider-thumb { background: #1f456e; }
.range-enhanced::-moz-range-thumb { background: #1f456e; }

.form-control-enhanced:focus { border-color: #1f456e; box-shadow: 0 0 0 4px rgba(31, 69, 110, 0.15); outline: none; }
.form-control-enhanced:focus-visible { outline-color: #1f456e; }

/* Status Badge Variants */
.status-success {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success-green);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.status-pending {
    background: rgba(245, 158, 11, 0.2);
    color: var(--warning-orange);
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.status-error {
    background: rgba(239, 68, 68, 0.2);
    color: var(--error-red);
    border: 1px solid rgba(239, 68, 68, 0.3);
}
</style>

<script>
// Helper: unified toast wrapper using global toastManager for consistent UI
function showToast(message, type = 'success', options = {}) {
    /**
     * Show a toast using the global ToastManager if available,
     * otherwise fall back gracefully.
     *
     * Args:
     * - message: Text to display.
     * - type: 'success' | 'error' | 'warning' | 'info' (accepts 'danger').
     * - options: { duration?: number, sticky?: boolean }
     */
    const mapType = (t) => {
        if (t === 'danger' || t === 'error') return 'error';
        if (t === 'warning') return 'warning';
        if (t === 'info') return 'info';
        return 'success';
    };
    const normalized = mapType(type);
    try {
        if (window.toastManager) {
            if (typeof window.toastManager.show === 'function') {
                window.toastManager.show(message, normalized, options);
                return;
            }
            if (typeof window.toastManager[normalized] === 'function') {
                window.toastManager[normalized](message);
                return;
            }
        }
        alert(message);
    } catch (_) {
        alert(message);
    }
}

// Basic cookie helper used by CSRF retrieval
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
}

// Handle fetch/network errors in a consistent way across the page
function handleFetchError(error) {
    console.error('Fetch error:', error);
    const message = (error && error.message) ? error.message : 'Network error. Please try again.';
    if (typeof showToast === 'function') {
        showToast(message, 'error');
    } else {
        alert(message);
    }
}
// CSRF token fallback helper
function getCSRFToken() {
    // 1) Marketplace AdminUtils, if present
    try {
        if (window.AdminUtils && typeof window.AdminUtils.getCSRFToken === 'function') {
            const v = window.AdminUtils.getCSRFToken();
            if (v) return v;
        }
    } catch (_) {}
    // 2) Cookie helper, if available
    try {
        if (typeof getCookie === 'function') {
            const v = getCookie('csrftoken');
            if (v) return v;
        }
    } catch (_) {}
    // 3) Hidden input rendered by Django {% csrf_token %}
    const inp = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (inp && inp.value) return inp.value;
    // 4) Meta tag fallbacks
    const meta = document.querySelector('meta[name="csrf-token"]')
             || document.querySelector('meta[name="x-csrftoken"]')
             || document.querySelector('meta[name="csrfmiddlewaretoken"]');
    if (meta && meta.content) return meta.content;
    return '';
}
// Safely parse JSON responses, falling back to text for HTML pages
async function parseJsonSafe(response) {
    const ct = (response.headers && response.headers.get && response.headers.get('content-type')) || '';
    if (ct && ct.includes('application/json')) {
        try { return await response.json(); } catch (_) { return null; }
    }
    try { return { _raw: await response.text() }; } catch (_) { return null; }
}
// Portion size display update
function updatePortionDisplay(value) {
    document.getElementById('portionDisplay').textContent = `${value} grams`;
    
    // Update slider background gradient
    const slider = document.getElementById('portionSlider');
    const percentage = ((value - slider.min) / (slider.max - slider.min)) * 100;
    slider.style.background = `linear-gradient(to right, #1f456e 0%, #1f456e ${percentage}%, var(--bg-secondary) ${percentage}%, var(--bg-secondary) 100%)`;
}

// Feed Now function
async function feedNow() {
    const button = document.getElementById('feedNowBtn');
    const portionSize = document.getElementById('portionSlider').value;
    
    setButtonLoading(button, true);
    
    try {
        const response = await fetch('/feed_now/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                portion_size: parseInt(portionSize),
                device_id: (window.DEVICE_ID || '{{ DEVICE_ID }}')
            })
        });
        const data = await parseJsonSafe(response);
        // Treat 409 Conflict (already pending) as soft success
        if (response.ok || response.status === 409) {
            const msg = (response.status === 409)
              ? `Feed command already queued${data && data.command_id ? ` (#${data.command_id})` : ''}.`
              : `Fed ${portionSize}g successfully!`;
            showToast(msg, 'success');
            loadRecentActivity();
            loadStats();
            updateLastFedTime();
        } else {
            const errMsg = (data && (data.message || data.error || data.detail))
                || (response.status === 401 || response.status === 403 ? 'Session expired. Please log in.' : null)
                || 'Failed to feed';
            showToast(errMsg, 'error');
        }
    } catch (error) {
        handleFetchError(error);
    } finally {
        setButtonLoading(button, false);
    }
}

// Quick Schedule form submission
document.getElementById('quickScheduleForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const selectedDaysLower = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => cb.value);
    const dayAbbrMap = { monday: 'Mon', tuesday: 'Tue', wednesday: 'Wed', thursday: 'Thu', friday: 'Fri', saturday: 'Sat', sunday: 'Sun' };
    const selectedDays = selectedDaysLower.map(d => dayAbbrMap[d] || d);
    
    if (selectedDays.length === 0) {
        showToast('Please select at least one day', 'warning');
        return;
    }
    
    const scheduleData = {
        time: formData.get('scheduleTime') || document.getElementById('scheduleTime').value,
        portion_size: parseInt(formData.get('scheduleAmount') || document.getElementById('scheduleAmount').value),
        days_of_week: selectedDays,
        enabled: true
    };
    
    const submitBtn = this.querySelector('button[type="submit"]');
    setButtonLoading(submitBtn, true);
    
    try {
        const response = await fetch('/api/schedules/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin',
            body: JSON.stringify(scheduleData)
        });
        const data = await parseJsonSafe(response);
        
        if (response.ok) {
            showToast('Schedule added successfully!', 'success');
            this.reset();
            // Uncheck all day toggles
            document.querySelectorAll('input[name="days"]').forEach(cb => cb.checked = false);
            loadStats();
        } else {
            const errMsg = (data && (data.message || data.error || data.detail))
                || (response.status === 401 || response.status === 403 ? 'Session expired. Please log in.' : null)
                || 'Failed to add schedule';
            showToast(errMsg, 'error');
        }
    } catch (error) {
        handleFetchError(error);
    } finally {
        setButtonLoading(submitBtn, false);
    }
});

// Load recent activity
async function loadRecentActivity() {
    try {
        const response = await fetch('/api/logs/?limit=5', {
            headers: { 'Accept': 'application/json' },
            credentials: 'same-origin'
        });
        const data = await parseJsonSafe(response);
        
        const tbody = document.getElementById('recentActivityTable');
        
        if (data && data.results && data.results.length > 0) {
            tbody.innerHTML = data.results.map(log => `
                <tr>
                    <td class="font-mono text-sm">${new Date(log.timestamp).toLocaleString()}</td>
                    <td>
                        <span class="flex items-center gap-2">
                            <i class="fas fa-${getFeedTypeIcon(log.feed_type)} text-[#1f456e]"></i>
                            ${getFeedTypeLabel(log.feed_type)}
                            ${log.action === 'feed' ? 'Manual Feed' : 'Scheduled Feed'}
                        </span>
                    </td>
                    <td class="font-semibold">${log.amount}g</td>
                    <td>
                        <span class="status-badge status-${log.success ? 'success' : 'error'}">
                            <i class="fas fa-${log.success ? 'check' : 'times'}"></i>
                            ${log.success ? 'Success' : 'Failed'}
                        </span>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-gray-400 py-8">
                        <i class="fas fa-info-circle mr-2"></i>
                        No recent activity
                    </td>
                </tr>
            `;
        }
    } catch (error) {
        console.error('Failed to load recent activity:', error);
        document.getElementById('recentActivityTable').innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-red-400 py-8">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Failed to load activity
                </td>
            </tr>
        `;
    }
}

// Load statistics
async function loadStats() {
    try {
        const [logsResponse, schedulesResponse] = await Promise.all([
            fetch('/api/logs/?limit=100', { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' }),
            fetch('/api/schedules/?page_size=100&ordering=-id', { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' })
        ]);
        
        const logsData = await parseJsonSafe(logsResponse);
        const schedulesData = await parseJsonSafe(schedulesResponse);
        
        // Calculate today's stats
        const today = new Date().toDateString();
        const todayLogs = logsData && logsData.results?.filter(log => 
            new Date(log.timestamp).toDateString() === today
        ) || [];
        
        document.getElementById('todayFeedings').textContent = todayLogs.length;
        document.getElementById('activeSchedules').textContent = 
            (schedulesData && schedulesData.results?.filter(s => s.enabled).length) || 0;
        document.getElementById('totalAmount').textContent = 
            `${todayLogs.reduce((sum, log) => sum + (log.amount || 0), 0)}g`;
            
    } catch (error) {
        console.error('Failed to load stats:', error);
        document.getElementById('todayFeedings').textContent = '?';
        document.getElementById('activeSchedules').textContent = '?';
        document.getElementById('totalAmount').textContent = '?';
    }
}

// Update last fed time
async function updateLastFedTime() {
    try {
        const response = await fetch('/api/logs/?limit=1', {
            headers: { 'Accept': 'application/json' },
            credentials: 'same-origin'
        });
        const data = await parseJsonSafe(response);
        
        if (data && data.results && data.results.length > 0) {
            const lastFed = new Date(data.results[0].timestamp);
            const now = new Date();
            const diffMinutes = Math.floor((now - lastFed) / (1000 * 60));
            
            let timeText;
            if (diffMinutes < 1) {
                timeText = 'Just now';
            } else if (diffMinutes < 60) {
                const hours = Math.floor(diffMinutes / 60);
                timeText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else if (diffMinutes < 1440) {
                const hours = Math.floor(diffMinutes / 60);
                timeText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else {
                timeText = lastFed.toLocaleDateString();
            }
            
            document.getElementById('lastFedTime').textContent = timeText;
        } else {
            document.getElementById('lastFedTime').textContent = 'Never';
        }
    } catch (error) {
        document.getElementById('lastFedTime').textContent = 'Unknown';
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updatePortionDisplay(25);
    loadRecentActivity();
    loadStats();
    updateLastFedTime();
    
    // Refresh data every 30 seconds
    setInterval(() => {
        loadRecentActivity();
        loadStats();
        updateLastFedTime();
    }, 30000);
});
// Feed type helpers for consistent labels/icons
function getFeedTypeIcon(type) {
    const icons = {
        manual: 'hand-paper',
        scheduled: 'clock',
        automatic: 'bolt'
    };
    return icons[type] || 'utensils';
}
function getFeedTypeLabel(type) {
    const labels = {
        manual: 'Manual Button',
        scheduled: 'Schedule',
        automatic: 'Automatic Button'
    };
    return labels[type] || 'Manual Button';
}
</script>
{% endblock %}

@media (max-width: 640px) {
    /* Make day pills more compact on small screens */
    .day-label {
        padding: 0.375rem 0.25rem;
        font-size: 0.75rem;
    }
}

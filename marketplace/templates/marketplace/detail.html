{% extends "marketplace/base_marketplace.html" %}
{% load static %}

{% block marketplace_title %}{{ listing.title|default:"Product Details" }}{% endblock %}
{% block marketplace_header %}{{ listing.title|default:"Product Details" }}{% endblock %}
{% block marketplace_subtitle %}View product information and contact seller{% endblock %}

{% block breadcrumbs %}
<li class="text-primary">{{ listing.title }}</li>
{% endblock %}

{% block marketplace_content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Product Image Section -->
    <div class="space-y-4">
        <!-- Main Product Image -->
        <div class="relative">
            <div class="carousel w-full rounded-xl bg-base-200 overflow-hidden">
                <div id="slide1" class="carousel-item w-full">
                    {% if listing.main_image %}
                    <img src="{{ listing.main_image.url }}" alt="{{ listing.title }}" class="w-full h-96 object-cover">
                    {% else %}
                    <img src="{% static 'img/placeholder.svg' %}" alt="{{ listing.title }}" class="w-full h-96 object-cover">
                    {% endif %}
                </div>
                <!-- Future slides: additional images when available -->
            </div>
            
            <!-- Image Controls -->
            <div class="absolute top-4 right-4 flex gap-2">
                <button class="btn btn-circle btn-sm bg-base-100/80 hover:bg-base-100" 
                        title="Zoom Image" 
                        onclick="openImageModal()">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="btn btn-circle btn-sm bg-base-100/80 hover:bg-base-100" 
                        title="Add to Wishlist">
                    <i class="fas fa-heart text-error"></i>
                </button>
            </div>
            
            <!-- Stock Status Badge -->
            <div class="badge {% if listing.quantity > 0 %}badge-success{% else %}badge-error{% endif %} absolute top-4 left-4">
                {% if listing.quantity > 0 %}In Stock{% else %}Out of Stock{% endif %}
            </div>
        </div>
        
        <!-- Image Upload Note (for sellers) -->
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <div>
                <div class="font-semibold">Image Policy</div>
                <div class="text-sm">Maximum 1 image per listing, 20MB limit. High-quality photos help sell faster!</div>
            </div>
        </div>
    </div>
    
    <!-- Product Information Section -->
    <div class="space-y-6">
        <!-- Product Header (dynamic) -->
        <div>
            <div class="badge badge-outline mb-2">{% if listing.category %}{{ listing.category.name }}{% else %}Uncategorized{% endif %}</div>
            <h1 class="text-3xl font-bold text-base-content mb-2">{{ listing.title }}</h1>
            <div class="flex items-center gap-2 text-base-content/70">
                <span class="text-sm">Listed {{ listing.created_at|timesince }} ago</span>
                <span class="text-sm">•</span>
                <span class="text-sm">ID: #{{ listing.pk }}</span>
            </div>
        </div>
        
        <!-- Price and Availability -->
        <div class="bg-base-200 rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="text-4xl font-bold text-primary">₱{{ listing.price }}</div>
                <div class="text-right">
                    <div class="text-lg font-semibold {% if listing.quantity > 0 %}text-success{% else %}text-error{% endif %}">
                        {{ listing.quantity }} Available
                    </div>
                    {% if listing.quantity > 0 and listing.quantity <= 3 %}
                    <div class="text-sm text-base-content/70">Only a few left!</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quantity Selector (buyer-only) -->
            {% if request.user.id != listing.seller_id %}
            <div class="flex items-center gap-4 mb-4">
                <label class="label">
                    <span class="label-text font-semibold">Quantity:</span>
                </label>
                <div class="join">
                    <button class="join-item btn btn-sm" onclick="decreaseQuantity()">-</button>
                    <input type="number" value="1" min="1" max="3" 
                           class="join-item input input-sm w-16 text-center" 
                           id="quantityInput">
                    <button class="join-item btn btn-sm" onclick="increaseQuantity()">+</button>
                </div>
            </div>
            {% endif %}
            
            <!-- Action Buttons -->
            <div class="space-y-3">
                {% if can_request_purchase %}
                <form method="post" action="{% url 'marketplace:request_purchase' listing.pk %}">
                    {% csrf_token %}
                    <button class="btn btn-primary request-purchase-btn btn-block">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Request to Purchase
                    </button>
                </form>
                {% endif %}
                {% if listing.is_fixed_price and listing.quantity > 0 and request.user.id != listing.seller_id %}
                <button id="buyNowBtn" type="button" class="btn btn-success btn-block">
                    <i class="fas fa-bolt mr-2"></i>
                    Buy Now
                </button>
                <div id="buyNowHelp" class="text-xs text-base-content/70 mt-1">Instant purchase for fixed-price listings.</div>
                {% endif %}
                {% if request.user.id != listing.seller_id %}
                <button class="btn btn-ghost btn-block" onclick="openMessageModal()">
                    <i class="fas fa-envelope mr-2"></i>
                    Message Seller
                </button>
                <div class="flex gap-2">
                    <button class="btn btn-outline btn-error flex-1" onclick="openReportModal()">
                        <i class="fas fa-flag mr-2"></i>
                        Report Listing
                    </button>
                    <button class="btn btn-outline flex-1" onclick="shareProduct()">
                        <i class="fas fa-share mr-2"></i>
                        Share
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Seller Information -->
        <div class="bg-base-200 rounded-xl p-6">
            <h3 class="font-semibold mb-4">Seller Information</h3>
            <div class="flex items-center gap-4">
                <div class="avatar placeholder">
                    <div class="bg-primary text-primary-content rounded-full w-12">
                        <span class="text-lg">{{ listing.seller.username|first|upper }}</span>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="font-semibold">@{{ listing.seller.username }}</div>
                    <div class="text-sm text-base-content/70">PETio seller</div>
                    <div class="flex items-center gap-2 mt-1">
                        {% if seller_rating_count %}
                        <div class="rating rating-sm">
                            <!-- simplistic stars based on avg rating -->
                            <span class="badge badge-outline">{{ seller_rating_avg|floatformat:1 }}/5 • {{ seller_rating_count }} reviews</span>
                        </div>
                        {% else %}
                        <span class="text-sm text-base-content/70">No ratings yet</span>
                        {% endif %}
                    </div>
                </div>
                {% if request.user.id == listing.seller_id %}
                {% url 'accounts:profile' as profile_url %}
                <a class="btn btn-ghost btn-sm" href="{{ profile_url }}">
                    <i class="fas fa-user"></i>
                    Your Profile
                </a>
                {% else %}
                {% url 'marketplace:user_profile' listing.seller_id as seller_public_profile_url %}
                <a class="btn btn-ghost btn-sm" href="{{ seller_public_profile_url }}">
                    <i class="fas fa-user"></i>
                    Seller Profile
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Product Description (dynamic) -->
{% if listing.description %}
<div class="bg-base-200 rounded-xl p-6 mb-8">
    <h2 class="text-2xl font-bold mb-4">Product Description</h2>
    <div class="prose max-w-none">
        <p class="text-base-content/80 leading-relaxed">{{ listing.description|linebreaksbr }}</p>
    </div>
</div>
{% endif %}

<!-- Specifications section removed; show when real structured specs exist -->

<!-- Reviews Section (Placeholder for future implementation) -->
<div class="bg-base-200 rounded-xl p-6 mb-8">
    <h2 class="text-2xl font-bold mb-4">Reviews & Ratings</h2>
    <div class="text-center py-8">
        <i class="fas fa-star text-4xl text-base-content/30 mb-4"></i>
        <h3 class="text-lg font-semibold mb-2">Reviews Coming Soon</h3>
        <p class="text-base-content/70">
            The review system will be available in a future update. For now, you can message the seller directly for more information.
        </p>
    </div>
</div>

<!-- Similar Products (dynamic by category) -->
{% if similar_listings %}
<div class="mb-8">
    <h2 class="text-2xl font-bold mb-6">Similar Products</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for item in similar_listings %}
        <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-all duration-300">
            <figure class="relative">
                {% if item.main_image %}
                <img src="{{ item.main_image.url }}" alt="{{ item.title }}" class="w-full h-32 object-cover">
                {% else %}
                <img src="{% static 'img/placeholder.svg' %}" alt="{{ item.title }}" class="w-full h-32 object-cover">
                {% endif %}
                {% if item.quantity == 0 %}
                <div class="badge badge-error absolute top-2 right-2">Out of Stock</div>
                {% elif item.quantity <= 2 %}
                <div class="badge badge-warning absolute top-2 right-2">Only {{ item.quantity }} left</div>
                {% else %}
                <div class="badge badge-success absolute top-2 right-2">In Stock</div>
                {% endif %}
            </figure>
            <div class="card-body p-4">
                <h3 class="card-title text-sm line-clamp-2">{{ item.title }}</h3>
                <div class="text-primary font-bold">₱{{ item.price }}</div>
                {% url 'marketplace:listing_detail' item.pk as view_url_local %}
                {% url 'marketplace:messages' as message_url_local %}
                {% include 'marketplace/components/card_actions.html' with view_url=view_url_local message_url=message_url_local view_label_long='View Details' view_label_short='View' %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Message Seller Modal -->
<dialog id="messageModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Message Seller</h3>
        <form method="dialog">
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Subject</span>
                </label>
                <input type="text" placeholder="Inquiry about {{ listing.title }}" 
                       class="input input-bordered" value="Inquiry about {{ listing.title }}">
            </div>
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Message</span>
                </label>
                <textarea class="textarea textarea-bordered h-24" 
                          placeholder="Hi! I'm interested in your pet food dispenser. Is it still available?"></textarea>
            </div>
            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="closeMessageModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Send Message</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Report Listing Modal -->
<dialog id="reportModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4 text-error">Report This Listing</h3>
        <form method="dialog">
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Reason for reporting</span>
                </label>
                <select class="select select-bordered">
                    <option>Select a reason...</option>
                    <option>Inappropriate content</option>
                    <option>Misleading information</option>
                    <option>Prohibited item (live animal/service)</option>
                    <option>Spam or duplicate listing</option>
                    <option>Suspected fraud</option>
                    <option>Other</option>
                </select>
            </div>
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Additional details (optional)</span>
                </label>
                <textarea class="textarea textarea-bordered h-20" 
                          placeholder="Please provide more details about the issue..."></textarea>
            </div>
            <div class="alert alert-warning mb-4">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="text-sm">
                    Reports are reviewed by our moderation team. False reports may result in account restrictions.
                </div>
            </div>
            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="closeReportModal()">Cancel</button>
                <button type="submit" class="btn btn-error">Submit Report</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Buy Now: Payment Method Modal -->
<dialog id="paymentModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Select Payment Method</h3>
        <p class="text-sm text-base-content/70 mb-4">Choose how you intend to pay for this item. Your selection will be attached to the order and you can finalize payment with the seller.</p>
        <div class="form-control mb-2">
            <label class="label cursor-pointer">
                <span class="label-text">COD (Cash on Delivery)</span>
                <input type="radio" name="paymentMethod" value="cod" class="radio" checked>
            </label>
        </div>
        <div class="form-control mb-4">
            <label class="label cursor-pointer">
                <span class="label-text">GCash</span>
                <input type="radio" name="paymentMethod" value="gcash" class="radio">
            </label>
        </div>
        <div class="modal-action">
            <button type="button" class="btn btn-ghost" onclick="document.getElementById('paymentModal').close()">Cancel</button>
            <button type="button" id="confirmPaymentBtn" class="btn btn-success">
                <i class="fas fa-check mr-2"></i>
                Confirm and Create Order
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
    </dialog>

<!-- Image Zoom Modal -->
<dialog id="imageModal" class="modal">
    <div class="modal-box max-w-4xl">
        <h3 class="font-bold text-lg mb-4">Product Image</h3>
        <figure class="mb-4">
            <img src="{% static 'img/placeholder.svg' %}" 
                 alt="{{ listing.title }} - Full Size" 
                 class="w-full rounded-lg">
        </figure>
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="closeImageModal()">Close</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{% endblock %}

{% block marketplace_scripts %}
<script>
/**
 * Product Detail Page JavaScript
 * Handles quantity selection, modals, and user interactions
 */

// Quantity management
function increaseQuantity() {
    const input = document.getElementById('quantityInput');
    const max = parseInt(input.getAttribute('max'));
    const current = parseInt(input.value);
    
    if (current < max) {
        input.value = current + 1;
    } else {
        showMarketplaceToast('Maximum quantity available is ' + max, 'warning');
    }
}

function decreaseQuantity() {
    const input = document.getElementById('quantityInput');
    const min = parseInt(input.getAttribute('min'));
    const current = parseInt(input.value);
    
    if (current > min) {
        input.value = current - 1;
    }
}

// Modal management
function openMessageModal() {
    document.getElementById('messageModal').showModal();
}

function closeMessageModal() {
    document.getElementById('messageModal').close();
}

function openReportModal() {
    document.getElementById('reportModal').showModal();
}

function closeReportModal() {
    document.getElementById('reportModal').close();
}

function openImageModal() {
    document.getElementById('imageModal').showModal();
}

function closeImageModal() {
    document.getElementById('imageModal').close();
}

// Share functionality
function shareProduct() {
    if (navigator.share) {
        navigator.share({
            title: '{{ listing.title }} - PETio Marketplace',
            text: 'Check out this pet food dispenser on PETio Marketplace!',
            url: window.location.href
        }).catch(console.error);
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(window.location.href).then(() => {
            showMarketplaceToast('Product link copied to clipboard!', 'success');
        }).catch(() => {
            showMarketplaceToast('Unable to share. Please copy the URL manually.', 'error');
        });
    }
}

// Form submissions
document.addEventListener('DOMContentLoaded', function() {
    // Message form submission
    const messageModal = document.getElementById('messageModal');
    const messageForm = messageModal.querySelector('form');
    
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Simulate sending message
        showMarketplaceToast('Message sent to seller!', 'success');
        closeMessageModal();
        
        // In a real implementation, you would send the data to the server here
        console.log('Message form submitted');
    });
    
    // Report form submission
    const reportModal = document.getElementById('reportModal');
    const reportForm = reportModal.querySelector('form');
    
    reportForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const reason = reportForm.querySelector('select').value;
        if (!reason || reason === 'Select a reason...') {
            showMarketplaceToast('Please select a reason for reporting', 'error');
            return;
        }
        
        // Simulate submitting report
        showMarketplaceToast('Report submitted. Thank you for helping keep our marketplace safe.', 'success');
        closeReportModal();
        
        // In a real implementation, you would send the data to the server here
        console.log('Report form submitted');
    });
    
    // Quantity input validation
    const quantityInput = document.getElementById('quantityInput');
    quantityInput.addEventListener('change', function() {
        const min = parseInt(this.getAttribute('min'));
        const max = parseInt(this.getAttribute('max'));
        let value = parseInt(this.value);
        
        if (isNaN(value) || value < min) {
            this.value = min;
        } else if (value > max) {
            this.value = max;
            showMarketplaceToast('Maximum quantity available is ' + max, 'warning');
        }
    });
});

// Wishlist functionality (placeholder)
function toggleWishlist() {
    const heartIcon = document.querySelector('.fa-heart');
    const isWishlisted = heartIcon.classList.contains('fas');
    
    if (isWishlisted) {
        heartIcon.classList.remove('fas');
        heartIcon.classList.add('far');
        showMarketplaceToast('Removed from wishlist', 'info');
    } else {
        heartIcon.classList.remove('far');
        heartIcon.classList.add('fas');
        showMarketplaceToast('Added to wishlist', 'success');
    }
}

// Add click handler for wishlist button
// Attach wishlist and Buy Now handlers immediately (script runs after DOM)
(function() {
    const wishlistBtn = document.querySelector('[title="Add to Wishlist"]');
    if (wishlistBtn) wishlistBtn.addEventListener('click', toggleWishlist);

    // Buy Now: open payment method modal
    const buyBtn = document.getElementById('buyNowBtn');
    if (!buyBtn) return;
    buyBtn.addEventListener('click', (e) => {
        // Guard against any default or bubbling that could trigger navigation
        if (e) { e.preventDefault(); e.stopPropagation(); }
        const modal = document.getElementById('paymentModal');
        if (modal && typeof modal.showModal === 'function') {
            modal.showModal();
        }
    });

    // Confirm payment selection and create awaiting-payment transaction
    const confirmBtn = document.getElementById('confirmPaymentBtn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', async () => {
            const modal = document.getElementById('paymentModal');
            const selected = document.querySelector('input[name="paymentMethod"]:checked');
            const paymentMethod = selected ? selected.value : null;
            try {
                const res = await fetch("{% url 'marketplace:api_listing_buy_now' listing.pk %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/) || [null, ''])[1],
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ payment_method: paymentMethod })
                });
                if (!res.ok) {
                    const body = await res.json().catch(() => ({}));
                    const msg = body.error || 'Unable to create order';
                    showMarketplaceToast(msg, 'error');
                    return;
                }
                const data = await res.json();
                showMarketplaceToast('Order created. Awaiting payment.', 'success');
                // Reflect quantity change immediately if present
                const qtyEl = document.querySelector('.text-lg.font-semibold');
                if (qtyEl && data.listing && typeof data.listing.quantity !== 'undefined') {
                    qtyEl.textContent = `${data.listing.quantity} Available`;
                }
                // Disable Buy Now and show progress
                buyBtn.disabled = true;
                buyBtn.classList.add('loading');
                buyBtn.textContent = 'Redirecting…';
                // Close modal and redirect to Transactions (confirmed tab)
                if (modal) modal.close();
                const txUrl = "{% url 'marketplace:transactions' %}?status=confirmed";
                setTimeout(() => { window.location.href = txUrl; }, 800);
            } catch (e) {
                showMarketplaceToast('Network error creating order', 'error');
            }
        });
    }
})();
</script>
{% endblock %}

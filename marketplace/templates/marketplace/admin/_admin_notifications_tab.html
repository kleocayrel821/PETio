{% comment %}Notifications tab partial: unified design with Listings tab{% endcomment %}

<!-- Header -->
<div class="flex items-center justify-between mb-4">
  <div>
    <h3 id="notifications-title" class="text-2xl font-semibold text-base-content">Broadcast Notification</h3>
    <p class="text-sm text-base-content/60 mt-1">Send announcements to marketplace users</p>
  </div>
  <div class="badge badge-lg badge-primary" id="broadcast-count">
    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <span id="broadcast-count-text">{{ recent_broadcasts|length|default:0 }} Sent</span>
  </div>
</div>

<!-- Broadcast Form -->
<div class="card bg-base-100 shadow-sm border border-base-200 mb-6">
  <div class="card-body p-4">
    <form id="notifications-form" role="form" aria-labelledby="notifications-title" method="post" action="{% url 'marketplace_admin:notifications_broadcast' %}">
      {% csrf_token %}
      <div class="form-control mb-3">
        <label class="label" for="broadcast-title">Title</label>
        <input id="broadcast-title" name="title" class="input input-bordered" placeholder="Announcement title" aria-label="Broadcast title" />
      </div>
      <div class="form-control mb-3">
        <label class="label" for="broadcast-body">Body</label>
        <textarea id="broadcast-body" name="body" class="textarea textarea-bordered" rows="4" placeholder="Announcement details" aria-label="Broadcast message"></textarea>
      </div>
      <div class="flex justify-end">
        <button id="broadcast-send" formaction="{% url 'marketplace_admin:notifications_broadcast' %}" formmethod="post" class="btn btn-primary" aria-label="Send broadcast">Send Broadcast</button>
      </div>
    </form>
  </div>
</div>

<!-- Recent Broadcasts -->
<div class="card bg-base-100 shadow-md">
  <div class="card-body">
    <h4 class="card-title">Recent Broadcasts</h4>
    <div id="notifications-history-empty" class="text-sm text-base-content/60 {% if recent_broadcasts %}hidden{% endif %}">No broadcasts yet.</div>
    <div class="overflow-x-auto">
      <table id="notifications-history-table" class="table table-compact w-full">
        <thead class="sticky top-0 bg-base-200">
          <tr>
            <th>Title</th>
            <th>Body</th>
            <th>Sent At</th>
          </tr>
        </thead>
        <tbody>
          {% for item in recent_broadcasts %}
          <tr>
            <td class="font-medium">{{ item.title }}</td>
            <td>{{ item.body|default:"" }}</td>
            <td>{{ item.created_at }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  /** Get CSRF token via AdminUtils fallback. */
  function getCsrf() {
    return (window.AdminUtils && typeof window.AdminUtils.getCSRFToken === 'function')
      ? window.AdminUtils.getCSRFToken()
      : (function(name){
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        })('csrftoken');
  }

  /** Post a broadcast announcement to the server. */
  async function postBroadcast(title, body) {
    const url = '{% url "marketplace_admin:notifications_broadcast" %}';
    const formData = new URLSearchParams();
    formData.append('title', title || '');
    formData.append('body', body || '');
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': getCsrf(),
        'Accept': 'application/json'
      },
      body: formData.toString()
    });
    const data = await resp.json().catch(() => ({ status: 'error', message: 'Invalid JSON' }));
    if (!resp.ok || data.status !== 'ok') {
      throw new Error(data.message || 'Broadcast failed');
    }
    return data;
  }

  /** Prepend a new broadcast row in the history table and update count. */
  function prependHistoryRow(title, body) {
    const table = document.getElementById('notifications-history-table');
    const empty = document.getElementById('notifications-history-empty');
    if (empty) empty.classList.add('hidden');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    const tr = document.createElement('tr');
    const tdTitle = document.createElement('td'); tdTitle.className = 'font-medium'; tdTitle.textContent = title || 'Announcement';
    const tdBody = document.createElement('td'); tdBody.textContent = body || '';
    const tdTime = document.createElement('td'); tdTime.textContent = new Date().toLocaleString();
    tr.appendChild(tdTitle); tr.appendChild(tdBody); tr.appendChild(tdTime);
    // Prepend row
    if (tbody.firstChild) { tbody.insertBefore(tr, tbody.firstChild); } else { tbody.appendChild(tr); }
    // Limit to recent 10 rows
    while (tbody.children.length > 10) { tbody.removeChild(tbody.lastElementChild); }
    // Update count badge
    const countEl = document.getElementById('broadcast-count-text');
    if (countEl) countEl.textContent = `${tbody.children.length} Sent`;
  }

  /** Initialize form handlers and wire up toasts. */
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('notifications-form');
    const btn = document.getElementById('broadcast-send');
    const titleInput = document.getElementById('broadcast-title');
    const bodyInput = document.getElementById('broadcast-body');
    const showToast = (window.AdminUtils?.showMarketplaceToast || ((msg)=>alert(msg)));

    const handler = async (ev) => {
      ev.preventDefault();
      try {
        const title = (titleInput.value || '').trim();
        const body = (bodyInput.value || '').trim();
        await postBroadcast(title, body);
        showToast('Notification sent');
        // Clear inputs
        titleInput.value = '';
        bodyInput.value = '';
        // Update history table optimistically
        prependHistoryRow(title || 'Announcement', body || '');
      } catch (err) {
        showToast(err.message || 'Broadcast failed');
      }
    };
    if (form) form.addEventListener('submit', handler);
    if (btn) btn.addEventListener('click', handler);
  });
</script>
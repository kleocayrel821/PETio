{% comment %}Enhanced Listings tab with professional design and improved UX{% endcomment %}

<!-- Header Section with Search & Filters -->
<div class="space-y-6">
  <!-- Page Header -->
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
    <div>
      <h3 class="text-2xl font-semibold text-base-content">Pending Listings</h3>
      <p class="mt-1 text-sm text-base-content/60">Review and moderate marketplace listings</p>
    </div>
    <div class="badge badge-lg badge-primary" id="pending-count">
      <svg class="mr-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <span id="count-text">0 Pending</span>
    </div>
  </div>

  <!-- Search & Filter Bar -->
  <div class="border shadow-sm card bg-base-100 border-base-200">
    <div class="p-4 card-body">
      <div class="flex flex-col gap-3 lg:flex-row">
        <!-- Search Input -->
        <div class="relative flex-1">
          <svg class="absolute left-3 top-1/2 w-5 h-5 -translate-y-1/2 text-base-content/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <input 
            type="text" 
            id="search-listings" 
            placeholder="Search by title, seller, or ID..." 
            class="pl-10 w-full transition-all input input-bordered focus:input-primary"
          />
        </div>
        
        <!-- Price Range Filter -->
        <select id="filter-price" class="select select-bordered focus:select-primary min-w-[140px]">
          <option value="">All Prices</option>
          <option value="0-500">₱0 - ₱500</option>
          <option value="500-1000">₱500 - ₱1,000</option>
          <option value="1000-5000">₱1K - ₱5K</option>
          <option value="5000+">₱5,000+</option>
        </select>

        <!-- Sort By -->
        <select id="filter-sort" class="select select-bordered focus:select-primary min-w-[140px]">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="price-high">Price: High to Low</option>
          <option value="price-low">Price: Low to High</option>
        </select>

        <!-- Bulk Actions -->
        <div class="dropdown dropdown-end" id="bulk-actions-dropdown" style="display: none;">
          <label tabindex="0" class="gap-2 btn btn-outline">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
            </svg>
            <span id="bulk-count">0 Selected</span>
          </label>
          <ul tabindex="0" class="p-2 mt-1 w-52 border shadow-lg dropdown-content menu bg-base-100 rounded-box border-base-200">
            <li><a id="bulk-approve" class="text-success"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Approve Selected</a></li>
            <li><a id="bulk-reject" class="text-error"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg> Reject Selected</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Skeleton -->
  <div id="listings-skeleton" class="space-y-2" style="display: none;">
    <div class="w-full h-16 skeleton"></div>
    <div class="w-full h-16 skeleton"></div>
    <div class="w-full h-16 skeleton"></div>
  </div>

  <!-- Listings Table -->
  <div class="overflow-hidden border shadow-md card bg-base-100 border-base-200">
    <div class="overflow-x-auto">
      <table id="listings-table" class="table w-full table-zebra">
        <thead class="sticky top-0 z-10 bg-base-200">
          <tr>
            <th class="w-12">
              <input type="checkbox" id="select-all" class="checkbox checkbox-sm" />
            </th>
            <th class="w-20">Preview</th>
            <th class="min-w-[80px]">ID</th>
            <th class="min-w-[200px]">Title</th>
            <th class="min-w-[120px]">Seller</th>
            <th class="min-w-[100px]">Price</th>
            <th class="min-w-[140px]">Submitted</th>
            <th class="min-w-[180px] text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for l in pending_listings %}
          <tr class="transition-colors hover:bg-base-200/50" data-listing-id="{{ l.id }}">
            <td>
              <input type="checkbox" class="checkbox checkbox-sm listing-checkbox" value="{{ l.id }}" />
            </td>
            <td>
              <div class="avatar">
                <div class="overflow-hidden w-12 h-12 rounded-lg border border-base-300 bg-base-200">
                  {% if l.main_image %}
                  <img src="{{ l.main_image.url }}" alt="{{ l.title }}" class="object-cover w-full h-full transition-transform cursor-pointer hover:scale-110" onclick="showImagePreview('{{ l.main_image.url }}', '{{ l.title|escapejs }}')" />
                  {% else %}
                  <div class="flex justify-center items-center w-full h-full text-base-content/30">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  {% endif %}
                </div>
              </div>
            </td>
            <td class="font-mono text-sm text-base-content/70">#{{ l.id }}</td>
            <td>
              <div class="flex flex-col">
                <span class="font-medium text-base-content line-clamp-1">{{ l.title }}</span>
                <span class="text-xs text-base-content/50">{{ l.category.name|default:"Uncategorized" }}</span>
              </div>
            </td>
            <td>
              <div class="flex gap-2 items-center">
                <div class="avatar placeholder">
                  <div class="w-8 h-8 text-xs rounded-full bg-primary text-primary-content">
                    <span>{{ l.seller.username|slice:":1"|upper }}</span>
                  </div>
                </div>
                <span class="text-sm">{{ l.seller.username }}</span>
              </div>
            </td>
            <td class="font-semibold text-primary">₱{{ l.price|floatformat:2 }}</td>
            <td>
              <div class="flex flex-col">
                <span class="text-sm text-base-content/70">{{ l.created_at|date:"M d, Y" }}</span>
                <span class="text-xs text-base-content/50">{{ l.created_at|date:"H:i" }}</span>
              </div>
            </td>
            <td>
              <div class="flex gap-2 justify-end">
                <button 
                  class="gap-1 transition-transform btn btn-sm btn-success hover:scale-105" 
                  data-action="approve" 
                  data-id="{{ l.id }}"
                  title="Approve listing"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Approve
                </button>
                <button 
                  class="gap-1 transition-transform btn btn-sm btn-error btn-outline hover:scale-105" 
                  data-action="reject" 
                  data-id="{{ l.id }}"
                  title="Reject listing"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                  Reject
                </button>
                <button 
                  class="btn btn-sm btn-ghost btn-square" 
                  data-action="quick-view" 
                  data-id="{{ l.id }}"
                  title="Quick view details"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8">
              <div class="flex flex-col justify-center items-center py-12 text-center">
                <svg class="mb-4 w-16 h-16 text-base-content/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <h4 class="mb-1 text-lg font-semibold text-base-content/60">No Pending Listings</h4>
                <p class="text-sm text-base-content/40">All listings have been reviewed</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Enhanced Rejection Modal -->
<div id="reject-modal" class="modal">
  <div class="relative max-w-lg modal-box">
    <!-- Close Button -->
    <button class="absolute top-4 right-4 btn btn-sm btn-circle btn-ghost" onclick="closeRejectModal()">✕</button>
    
    <!-- Modal Header -->
    <div class="flex gap-3 items-center mb-6">
      <div class="flex flex-shrink-0 justify-center items-center w-12 h-12 rounded-full bg-error/10">
        <svg class="w-6 h-6 text-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-1.964-1.333-2.732 0L3.732 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
      </div>
      <div>
        <h3 class="text-xl font-bold text-base-content">Reject Listing</h3>
        <p class="text-sm text-base-content/60">Provide a reason for rejection</p>
      </div>
    </div>

    <!-- Listing Info (populated dynamically) -->
    <div class="mb-4 alert alert-warning" id="reject-listing-info" style="display: none;">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div class="text-sm">
        <div class="font-semibold" id="reject-listing-title"></div>
        <div class="text-xs opacity-70">by <span id="reject-listing-seller"></span></div>
      </div>
    </div>

    <!-- Reason Code (Required) -->
    <div class="mb-4 form-control">
      <label class="label">
        <span class="font-medium label-text">Rejection Reason <span class="text-error">*</span></span>
      </label>
      <select id="reject-reason-code" class="w-full select select-bordered focus:select-error">
        <option value="" disabled selected>Select a reason...</option>
        {% for code,label in rejection_reason_choices %}
          <option value="{{ code }}">{{ label }}</option>
        {% endfor %}
      </select>
      <label class="label">
        <span class="hidden label-text-alt text-error" id="reason-code-error">Please select a rejection reason</span>
      </label>
    </div>

    <!-- Additional Notes (Optional) -->
    <div class="mb-6 form-control">
      <label class="label">
        <span class="font-medium label-text">Additional Notes (Optional)</span>
        <span class="label-text-alt text-base-content/50" id="reason-char-count">0/500</span>
      </label>
      <textarea 
        id="reject-reason" 
        class="h-24 resize-none textarea textarea-bordered focus:textarea-error" 
        placeholder="Provide additional context or suggestions for the seller..."
        maxlength="500"
      ></textarea>
    </div>

    <!-- Modal Actions -->
    <div class="justify-between modal-action">
      <button class="btn btn-ghost" onclick="closeRejectModal()">Cancel</button>
      <button id="reject-confirm" class="gap-2 btn btn-error">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        Confirm Rejection
      </button>
    </div>
  </div>
  <div class="modal-backdrop" onclick="closeRejectModal()"></div>
</div>

<!-- Image Preview Modal -->
<div id="image-preview-modal" class="modal">
  <div class="max-w-3xl modal-box">
    <button class="absolute top-4 right-4 btn btn-sm btn-circle btn-ghost" onclick="closeImagePreview()">✕</button>
    <h3 class="mb-4 text-lg font-bold" id="preview-title"></h3>
    <img id="preview-image" src="" alt="" class="w-full rounded-lg" />
  </div>
  <div class="modal-backdrop" onclick="closeImagePreview()"></div>
</div>

<!-- Quick View Modal -->
<div id="quick-view-modal" class="modal">
  <div class="max-w-2xl modal-box">
    <button class="absolute top-4 right-4 btn btn-sm btn-circle btn-ghost" onclick="closeQuickView()">✕</button>
    <div id="quick-view-content" class="space-y-4">
      <!-- Content loaded dynamically -->
      <div class="flex justify-center py-8">
        <span class="loading loading-spinner loading-lg"></span>
      </div>
    </div>
  </div>
  <div class="modal-backdrop" onclick="closeQuickView()"></div>
</div>

<script>
  // ===== Utility Functions =====
  function getCSRFToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta && meta.content && meta.content !== 'NOTPROVIDED') return meta.content;
    const input = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (input && input.value) return input.value;
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
  }

  /**
   * Safely escape HTML special characters for string interpolation.
   * Prevents XSS when inserting user-provided content into innerHTML.
   */
  function escapeHTML(str) {
    if (str == null) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  const csrftoken = getCSRFToken();
  let pendingRejectId = null;
  let selectedListings = new Set();

  // ===== Toast Notification =====
  function showToast(message, type = 'info') {
    // Check if showMarketplaceToast exists globally
    if (typeof showMarketplaceToast === 'function') {
      showMarketplaceToast(message, type);
    } else {
      // Fallback to alert if toast function not available
      alert(message);
    }
  }

  // ===== Fetch Listings =====
  async function fetchListings() {
    const skeleton = document.getElementById('listings-skeleton');
    const table = document.getElementById('listings-table');
    
    try {
      if (skeleton) skeleton.style.display = 'block';
      if (table) table.style.opacity = '0.5';

      const url = new URL(window.location.href);
      url.searchParams.set('format', 'json');
      
      const res = await fetch(url.toString(), { 
        headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json' } 
      });
      const data = await res.json();
      
      if (data.status !== 'ok') throw new Error(data.message || 'Failed');
      
      renderListings(data.listings);
      updatePendingCount(data.listings.length);
    } catch (e) {
      console.error('Failed to fetch listings', e);
      showToast('Failed to load listings', 'error');
    } finally {
      if (skeleton) skeleton.style.display = 'none';
      if (table) table.style.opacity = '1';
    }
  }

  // ===== Render Listings =====
  function renderListings(listings) {
    const tbody = document.querySelector('#listings-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    selectedListings.clear();
    updateBulkActions();
    
    if (!listings || listings.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="8">
            <div class="flex flex-col justify-center items-center py-12 text-center">
              <svg class="mb-4 w-16 h-16 text-base-content/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <h4 class="mb-1 text-lg font-semibold text-base-content/60">No Pending Listings</h4>
              <p class="text-sm text-base-content/40">All listings have been reviewed</p>
            </div>
          </td>
        </tr>
      `;
      return;
    }
    
    for (const l of listings) {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-base-200/50 transition-colors';
      tr.dataset.listingId = l.id;
      
      tr.innerHTML = `
        <td>
          <input type="checkbox" class="checkbox checkbox-sm listing-checkbox" value="${l.id}" />
        </td>
        <td>
          <div class="avatar">
            <div class="overflow-hidden w-12 h-12 rounded-lg border border-base-300 bg-base-200">
              ${l.image ? 
                `<img src="${l.image}" alt="${l.title}" class="object-cover w-full h-full transition-transform cursor-pointer hover:scale-110" onclick="showImagePreview('${l.image}', '${l.title}')" />` :
                `<div class="flex justify-center items-center w-full h-full text-base-content/30">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                </div>`
              }
            </div>
          </div>
        </td>
        <td class="font-mono text-sm text-base-content/70">#${l.id}</td>
        <td>
          <div class="flex flex-col">
            <span class="font-medium text-base-content line-clamp-1">${l.title}</span>
            <span class="text-xs text-base-content/50">${l.category || 'Uncategorized'}</span>
          </div>
        </td>
        <td>
          <div class="flex gap-2 items-center">
            <div class="avatar placeholder">
              <div class="w-8 h-8 text-xs rounded-full bg-primary text-primary-content">
                <span>${l.seller.charAt(0).toUpperCase()}</span>
              </div>
            </div>
            <span class="text-sm">${l.seller}</span>
          </div>
        </td>
        <td class="font-semibold text-primary">₱${Number(l.price).toFixed(2)}</td>
        <td>
          <div class="flex flex-col">
            <span class="text-sm text-base-content/70">${l.submitted_date || ''}</span>
            <span class="text-xs text-base-content/50">${l.submitted_time || ''}</span>
          </div>
        </td>
        <td>
          <div class="flex gap-2 justify-end">
            <button class="gap-1 transition-transform btn btn-sm btn-success hover:scale-105" data-action="approve" data-id="${l.id}" title="Approve listing">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Approve
            </button>
            <button class="gap-1 transition-transform btn btn-sm btn-error btn-outline hover:scale-105" data-action="reject" data-id="${l.id}" title="Reject listing">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
              Reject
            </button>
            <button class="btn btn-sm btn-ghost btn-square" data-action="quick-view" data-id="${l.id}" title="Quick view details">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }

    // Reattach checkbox listeners
    attachCheckboxListeners();
  }

  // ===== Update Pending Count =====
  function updatePendingCount(count) {
    const countEl = document.getElementById('count-text');
    if (countEl) {
      countEl.textContent = `${count} Pending`;
    }
  }

  // ===== Post Action =====
  async function postAction(url, body) {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json',
      },
      body: new URLSearchParams(body).toString(),
      credentials: 'same-origin',
    });
    const ct = res.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      const data = await res.json();
      if (!res.ok) {
        const msg = (data && (data.message || data.error || data.detail)) || `Request failed (${res.status})`;
        throw new Error(msg);
      }
      return data;
    }
    const text = await res.text();
    if (res.status === 401 || res.status === 403 || res.redirected) {
      throw new Error('Session expired or permission denied.');
    }
    throw new Error('Unexpected server response.');
  }

  // ===== Handle Approve =====
  async function handleApprove(listingId, skipRefresh = false) {
    const btn = document.querySelector(`button[data-action="approve"][data-id="${listingId}"]`);
    const originalHTML = btn ? btn.innerHTML : '';
    
    try {
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Approving...';
      }

      const url = `{% url 'marketplace_admin:approve_listing' 0 %}`.replace('/0/', `/${listingId}/`);
      const data = await postAction(url, {});
      
      if (data.status === 'ok') {
        showToast('Listing approved successfully', 'success');
        if (!skipRefresh) await fetchListings();
      } else {
        throw new Error(data.message || 'Approve failed');
      }
    } catch (err) {
      console.error('Approve error:', err);
      showToast(err.message || 'Failed to approve listing', 'error');
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      }
    }
  }

  // ===== Rejection Modal =====
  function openRejectModal(listingId) {
    pendingRejectId = listingId;
    
    // Clear form
    document.getElementById('reject-reason').value = '';
    document.getElementById('reject-reason-code').value = '';
    document.getElementById('reason-code-error').classList.add('hidden');
    
    // Show modal
    document.getElementById('reject-modal').classList.add('modal-open');
  }

  function closeRejectModal() {
    document.getElementById('reject-modal').classList.remove('modal-open');
    pendingRejectId = null;
  }

  async function handleRejectConfirm() {
    if (!pendingRejectId) return closeRejectModal();
    
    const reasonCode = document.getElementById('reject-reason-code').value;
    const reasonText = document.getElementById('reject-reason').value || '';
    const errorEl = document.getElementById('reason-code-error');
    
    // Validate reason code
    if (!reasonCode) {
      errorEl.classList.remove('hidden');
      document.getElementById('reject-reason-code').classList.add('select-error');
      return;
    }
    
    const btn = document.getElementById('reject-confirm');
    const originalHTML = btn.innerHTML;
    
    try {
      btn.disabled = true;
      btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Rejecting...';
      
      const url = `{% url 'marketplace_admin:reject_listing' 0 %}`.replace('/0/', `/${pendingRejectId}/`);
      const data = await postAction(url, { 
        reason: reasonText, 
        reason_code: reasonCode 
      });
      
      if (data.status === 'ok') {
        showToast('Listing rejected successfully', 'success');
        closeRejectModal();
        await fetchListings();
      } else {
        throw new Error(data.message || 'Reject failed');
      }
    } catch (err) {
      console.error('Reject error:', err);
      showToast(err.message || 'Failed to reject listing', 'error');
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  }

  // ===== Checkbox Management =====
  function attachCheckboxListeners() {
    const checkboxes = document.querySelectorAll('.listing-checkbox');
    checkboxes.forEach(cb => {
      cb.addEventListener('change', handleCheckboxChange);
    });
  }

  function handleCheckboxChange(e) {
    const listingId = parseInt(e.target.value);
    if (e.target.checked) {
      selectedListings.add(listingId);
    } else {
      selectedListings.delete(listingId);
    }
    updateBulkActions();
    updateSelectAllState();
  }

  function updateBulkActions() {
    const dropdown = document.getElementById('bulk-actions-dropdown');
    const countEl = document.getElementById('bulk-count');
    
    if (selectedListings.size > 0) {
      dropdown.style.display = 'block';
      countEl.textContent = `${selectedListings.size} Selected`;
    } else {
      dropdown.style.display = 'none';
    }
  }

  function updateSelectAllState() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.listing-checkbox');
    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    
    if (selectAll) {
      selectAll.checked = checkedCount > 0 && checkedCount === checkboxes.length;
      selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    }
  }

  // ===== Select All Handler =====
  document.getElementById('select-all')?.addEventListener('change', (e) => {
    const checkboxes = document.querySelectorAll('.listing-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = e.target.checked;
      const listingId = parseInt(cb.value);
      if (e.target.checked) {
        selectedListings.add(listingId);
      } else {
        selectedListings.delete(listingId);
      }
    });
    updateBulkActions();
  });

  // ===== Bulk Actions =====
  document.getElementById('bulk-approve')?.addEventListener('click', async (e) => {
    e.preventDefault();
    
    if (selectedListings.size === 0) return;
    
    const confirmed = confirm(`Are you sure you want to approve ${selectedListings.size} listing(s)?`);
    if (!confirmed) return;
    
    const promises = Array.from(selectedListings).map(id => handleApprove(id, true));
    
    try {
      await Promise.all(promises);
      showToast(`${selectedListings.size} listing(s) approved`, 'success');
      selectedListings.clear();
      await fetchListings();
    } catch (err) {
      showToast('Some listings failed to approve', 'error');
    }
  });

  document.getElementById('bulk-reject')?.addEventListener('click', async (e) => {
    e.preventDefault();
    if (selectedListings.size === 0) return;
    
    alert('Bulk rejection requires selecting a reason. Please reject listings individually for now.');
  });

  // ===== Image Preview =====
  function showImagePreview(imageUrl, title) {
    document.getElementById('preview-image').src = imageUrl;
    document.getElementById('preview-title').textContent = title;
    document.getElementById('image-preview-modal').classList.add('modal-open');
  }

  function closeImagePreview() {
    document.getElementById('image-preview-modal').classList.remove('modal-open');
  }

  // ===== Quick View =====
  /**
   * Show a filled-in preview of listing details in the admin Quick View modal.
   * Fetches JSON from the Marketplace API and renders title, category, price,
   * quantity, seller, created date, description, and main image.
   */
  async function showQuickView(listingId) {
    const modal = document.getElementById('quick-view-modal');
    const content = document.getElementById('quick-view-content');

    modal.classList.add('modal-open');
    content.innerHTML = '<div class="flex justify-center py-8"><span class="loading loading-spinner loading-lg"></span></div>';

    try {
      const apiUrl = `/marketplace/api/listings/${listingId}/`;
      const res = await fetch(apiUrl, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('Failed to load details');

      const data = await res.json();

      const imgHTML = data.main_image
        ? `<img src="${data.main_image}" alt="${escapeHTML(data.title)}" class="object-cover w-full h-full" />`
        : `<div class="flex justify-center items-center w-full h-full text-base-content/30">
             <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
             </svg>
           </div>`;

      const priceText = (window.AdminUtils && typeof window.AdminUtils.formatCurrencyPHP === 'function')
        ? window.AdminUtils.formatCurrencyPHP(data.price)
        : `₱${Number(data.price || 0).toFixed(2)}`;

      const createdText = data.created_at
        ? new Date(data.created_at).toLocaleString()
        : '';

      const categoryName = (data.category && data.category.name) ? data.category.name : 'Uncategorized';
      const sellerName = (data.seller && data.seller.username) ? data.seller.username : 'Unknown';
      const fullPageUrl = `/marketplace/listing/${listingId}/`;

      content.innerHTML = `
        <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
          <div class="md:col-span-1">
            <div class="overflow-hidden w-full h-48 rounded-lg border md:h-full border-base-300 bg-base-200">
              ${imgHTML}
            </div>
          </div>
          <div class="md:col-span-2">
            <h3 class="mb-1 text-xl font-bold">${escapeHTML(data.title)}</h3>
            <div class="mb-3 text-sm text-base-content/60">${escapeHTML(categoryName)} • Qty: ${Number(data.quantity || 0)}</div>
            <div class="mb-3 font-semibold text-primary">${priceText}</div>

            <div class="mb-4 space-y-1 text-sm text-base-content/70">
              <div><span class="font-medium">Seller:</span> ${escapeHTML(sellerName)}</div>
              <div><span class="font-medium">Created:</span> ${escapeHTML(createdText)}</div>
              <div><span class="font-medium">Status:</span> ${escapeHTML(data.status || 'pending')}</div>
            </div>

            <div class="max-w-none prose">
              <p>${escapeHTML(data.description || '')}</p>
            </div>

            <div class="flex gap-2 mt-6">
              <a href="${fullPageUrl}" target="_blank" class="btn btn-primary btn-sm">
                Open Full Listing
                <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
              </a>
            </div>
          </div>
        </div>
      `;
    } catch (err) {
      console.error('Quick view error:', err);
      content.innerHTML = `
        <div class="alert alert-error">
          <span>Failed to load listing details</span>
        </div>
      `;
    }
  }

  function closeQuickView() {
    document.getElementById('quick-view-modal').classList.remove('modal-open');
  }

  // ===== Search & Filter =====
  let searchTimeout;
  document.getElementById('search-listings')?.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      filterListings();
    }, 300); // Debounce 300ms
  });

  document.getElementById('filter-price')?.addEventListener('change', filterListings);
  document.getElementById('filter-sort')?.addEventListener('change', filterListings);

  function filterListings() {
    const searchTerm = document.getElementById('search-listings')?.value.toLowerCase() || '';
    const priceRange = document.getElementById('filter-price')?.value || '';
    const sortBy = document.getElementById('filter-sort')?.value || 'newest';
    
    const rows = Array.from(document.querySelectorAll('#listings-table tbody tr[data-listing-id]'));
    
    // Filter
    rows.forEach(row => {
      const title = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';
      const seller = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';
      const id = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
      const priceText = row.querySelector('td:nth-child(6)')?.textContent || '';
      const price = parseFloat(priceText.replace(/[^0-9.]/g, ''));
      
      let matchesSearch = !searchTerm || title.includes(searchTerm) || seller.includes(searchTerm) || id.includes(searchTerm);
      let matchesPrice = true;
      
      if (priceRange) {
        if (priceRange === '0-500') matchesPrice = price >= 0 && price <= 500;
        else if (priceRange === '500-1000') matchesPrice = price > 500 && price <= 1000;
        else if (priceRange === '1000-5000') matchesPrice = price > 1000 && price <= 5000;
        else if (priceRange === '5000+') matchesPrice = price > 5000;
      }
      
      row.style.display = (matchesSearch && matchesPrice) ? '' : 'none';
    });
    
    // Sort visible rows
    const visibleRows = rows.filter(row => row.style.display !== 'none');
    visibleRows.sort((a, b) => {
      if (sortBy === 'newest' || sortBy === 'oldest') {
        const dateA = a.querySelector('td:nth-child(7)')?.textContent || '';
        const dateB = b.querySelector('td:nth-child(7)')?.textContent || '';
        return sortBy === 'newest' ? dateB.localeCompare(dateA) : dateA.localeCompare(dateB);
      } else if (sortBy === 'price-high' || sortBy === 'price-low') {
        const priceA = parseFloat(a.querySelector('td:nth-child(6)')?.textContent.replace(/[^0-9.]/g, '') || '0');
        const priceB = parseFloat(b.querySelector('td:nth-child(6)')?.textContent.replace(/[^0-9.]/g, '') || '0');
        return sortBy === 'price-high' ? priceB - priceA : priceA - priceB;
      }
      return 0;
    });
    
    // Reorder in DOM
    const tbody = document.querySelector('#listings-table tbody');
    visibleRows.forEach(row => tbody.appendChild(row));
  }

  // ===== Character Counter =====
  document.getElementById('reject-reason')?.addEventListener('input', (e) => {
    const counter = document.getElementById('reason-char-count');
    if (counter) {
      counter.textContent = `${e.target.value.length}/500`;
    }
  });

  // Clear error on reason code change
  document.getElementById('reject-reason-code')?.addEventListener('change', (e) => {
    document.getElementById('reason-code-error')?.classList.add('hidden');
    e.target.classList.remove('select-error');
  });

  // ===== Event Delegation for Action Buttons =====
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    
    const action = btn.getAttribute('data-action');
    const id = btn.getAttribute('data-id');
    
    if (action === 'approve' && id) {
      e.preventDefault();
      handleApprove(id);
    } else if (action === 'reject' && id) {
      e.preventDefault();
      openRejectModal(id);
    } else if (action === 'quick-view' && id) {
      e.preventDefault();
      showQuickView(id);
    }
  });

  // ===== Modal Button Handlers =====
  document.getElementById('reject-confirm')?.addEventListener('click', (e) => {
    e.preventDefault();
    handleRejectConfirm();
  });

  // ===== Keyboard Shortcuts =====
  document.addEventListener('keydown', (e) => {
    // ESC to close modals
    if (e.key === 'Escape') {
      if (document.getElementById('reject-modal').classList.contains('modal-open')) {
        closeRejectModal();
      }
      if (document.getElementById('image-preview-modal').classList.contains('modal-open')) {
        closeImagePreview();
      }
      if (document.getElementById('quick-view-modal').classList.contains('modal-open')) {
        closeQuickView();
      }
    }
  });

  // ===== Initialize =====
  document.addEventListener('DOMContentLoaded', () => {
    // Initial fetch
    fetchListings();
    
    // Attach checkbox listeners for initial render
    attachCheckboxListeners();
  });
  
  // Initial refresh to ensure table sync
  fetchListings();
</script>

<style>
  /* Custom animations */
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #listings-table tbody tr {
    animation: slideIn 0.3s ease-out;
  }

  /* Smooth transitions */
  .btn {
    transition: all 0.2s ease;
  }

  /* Modal backdrop */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  /* Improved table hover */
  #listings-table tbody tr:hover {
    transform: scale(1.001);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  /* Line clamp utility */
  .line-clamp-1 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 1;
  }

  /* Skeleton loading */
  .skeleton {
    background: linear-gradient(90deg, 
      rgba(255, 255, 255, 0) 0%, 
      rgba(255, 255, 255, 0.2) 50%, 
      rgba(255, 255, 255, 0) 100%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  /* Better focus states */
  .input:focus, .select:focus, .textarea:focus {
    outline: 2px solid hsl(var(--p));
    outline-offset: 2px;
  }
</style>

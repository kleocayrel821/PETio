{% extends 'marketplace/base_marketplace.html' %}
{% block title %}Marketplace Dashboard{% endblock %}
{% block marketplace_header_section %}{% endblock %}
{% block marketplace_header %}{% endblock %}
{% block marketplace_subtitle %}{% endblock %}
{% block breadcrumbs %}
{# Breadcrumbs removed #}
{% endblock %}
{% block marketplace_content %}
<div class="space-y-6">
  <!-- Metrics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="card bg-base-100 shadow p-6 flex items-center justify-between">
      <div>
        <div class="text-xs opacity-60">Total Products</div>
        <div class="text-4xl font-bold text-indigo-600">{{ global_stats.total_products|default:0 }}</div>
        <div class="text-xs opacity-60">{{ global_stats.new_products_week|default:0 }} new this week</div>
      </div>
      <div class="text-indigo-600 text-2xl">
        <i class="fas fa-gift"></i>
      </div>
    </div>
    <div class="card bg-base-100 shadow p-6 flex items-center justify-between">
      <div>
        <div class="text-xs opacity-60">Active Sellers</div>
        <div class="text-4xl font-bold text-pink-500">{{ global_stats.active_sellers|default:0 }}</div>
        <div class="text-xs opacity-60">{{ global_stats.new_sellers_week|default:0 }} new sellers</div>
      </div>
      <div class="text-pink-500 text-2xl">
        <i class="fas fa-users"></i>
      </div>
    </div>
    <div class="card bg-base-100 shadow p-6 flex items-center justify-between">
      <div>
        <div class="text-xs opacity-60">Categories</div>
        <div class="text-4xl font-bold text-teal-500">{{ global_stats.categories|default:0 }}</div>
        <div class="text-xs opacity-60">Pet products only</div>
      </div>
      <div class="text-teal-500 text-2xl">
        <i class="fas fa-tags"></i>
      </div>
    </div>
  </div>

  <!-- Filters Bar -->
  <div class="card bg-base-100 shadow p-4">
    <div class="flex flex-wrap items-center gap-2">
      <a href="{% url 'marketplace:dashboard' %}" class="btn btn-sm {% if not status_filter %}btn-active{% endif %}">
        All <span class="badge badge-outline ml-2">{{ base_count }}</span>
      </a>
      <a href="{% url 'marketplace:dashboard' %}?status=draft" class="btn btn-sm {% if status_filter == 'draft' %}btn-active{% endif %}">
        Draft <span class="badge badge-outline ml-2">{{ status_counts.draft|default:0 }}</span>
      </a>
      <a href="{% url 'marketplace:dashboard' %}?status=pending" class="btn btn-sm {% if status_filter == 'pending' %}btn-active{% endif %}">
        Pending <span class="badge badge-outline ml-2">{{ status_counts.pending|default:0 }}</span>
      </a>
      <a href="{% url 'marketplace:dashboard' %}?status=active" class="btn btn-sm {% if status_filter == 'active' %}btn-active{% endif %}">
        Active <span class="badge badge-outline ml-2">{{ status_counts.active|default:0 }}</span>
      </a>
      <a href="{% url 'marketplace:dashboard' %}?status=sold" class="btn btn-sm {% if status_filter == 'sold' %}btn-active{% endif %}">
        Sold <span class="badge badge-outline ml-2">{{ status_counts.sold|default:0 }}</span>
      </a>
      <a href="{% url 'marketplace:dashboard' %}?status=archived" class="btn btn-sm {% if status_filter == 'archived' %}btn-active{% endif %}">
        Archived <span class="badge badge-outline ml-2">{{ status_counts.archived|default:0 }}</span>
      </a>
      <div class="ml-auto">
        <a href="{% url 'marketplace:listing_create' %}" class="btn btn-primary btn-sm">
          <i class="fas fa-plus"></i>
          New Listing
        </a>
      </div>
    </div>
  </div>

  <!-- Listings Grid -->
  {% if my_listings %}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for listing in my_listings %}
    <div class="card bg-base-100 shadow-md">
      <div class="card-body">
        <div class="flex items-start gap-3">
          <div class="flex-1">
            <h3 class="card-title">
              <a href="{% url 'marketplace:listing_detail' listing.pk %}" class="link link-hover">{{ listing.title }}</a>
            </h3>
            <div class="text-sm opacity-70">{{ listing.category.name|default:"Uncategorized" }}</div>
          </div>
          <div>
            <span class="badge {% if listing.status == 'active' %}badge-success{% elif listing.status == 'pending' %}badge-warning{% elif listing.status == 'draft' %}badge-neutral{% elif listing.status == 'sold' %}badge-info{% else %}badge-outline{% endif %}">{{ listing.get_status_display }}</span>
          </div>
        </div>
        <div class="mt-2 flex items-center justify-between">
          <div class="text-lg font-semibold">₱{{ listing.price }}</div>
          <div class="text-sm">
            {% if listing.quantity <= 0 %}
              Out of stock
            {% elif listing.quantity == 1 %}
              1 left
            {% elif listing.quantity <= 5 %}
              Only {{ listing.quantity }} left
            {% else %}
              {{ listing.quantity }} available
            {% endif %}
          </div>
        </div>
        {% if listing.latest_txn %}
        <div class="mt-2 text-sm flex items-center gap-2">
          <span class="opacity-70">Txn:</span>
          <span class="badge {% if listing.latest_txn.status == 'awaiting_payment' %}badge-warning{% elif listing.latest_txn.status == 'paid' %}badge-info{% elif listing.latest_txn.status == 'completed' %}badge-success{% else %}badge-outline{% endif %}">{{ listing.latest_txn.get_status_display }}</span>
        </div>
        {% endif %}
        <div class="mt-4 flex flex-wrap gap-2">
          <!-- Inline action buttons: reserve, sell, complete -->
          <button class="btn btn-sm" data-action="reserve" data-listing-id="{{ listing.id }}" {% if listing.status != 'active' %}disabled{% endif %}>
            <i class="fas fa-handshake"></i>
            Reserve
          </button>
          <button class="btn btn-sm" data-action="sell" data-listing-id="{{ listing.id }}" {% if listing.status != 'pending' or not listing.latest_txn or listing.latest_txn.status != 'awaiting_payment' %}disabled{% endif %}>
            <i class="fas fa-money-bill-wave"></i>
            Mark Sold
          </button>
          <button class="btn btn-sm" data-action="complete" data-listing-id="{{ listing.id }}" {% if not listing.latest_txn or listing.latest_txn.status != 'paid' %}disabled{% endif %}>
            <i class="fas fa-check"></i>
            Complete
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if is_paginated %}
  <div class="join mt-4">
    {% if page_obj.has_previous %}
      <a class="join-item btn" href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}">« Prev</a>
    {% else %}
      <button class="join-item btn" disabled>« Prev</button>
    {% endif %}
    <button class="join-item btn">Page {{ page_obj.number }} of {{ paginator.num_pages }}</button>
    {% if page_obj.has_next %}
      <a class="join-item btn" href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}">Next »</a>
    {% else %}
      <button class="join-item btn" disabled>Next »</button>
    {% endif %}
  </div>
  {% endif %}
  {% else %}
    <div class="alert alert-info">
      <i class="fas fa-info-circle"></i>
      You have no listings yet. Create your first one!
    </div>
  {% endif %}
</div>
{% endblock %}

{% block marketplace_scripts %}
<script>
// Helper to get CSRF token from cookie
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

async function postJSON(url, payload = {}) {
  const resp = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken'),
    },
    body: JSON.stringify(payload)
  });
  if (!resp.ok) {
    const text = await resp.text();
    throw new Error(`HTTP ${resp.status}: ${text}`);
  }
  return resp.json().catch(() => ({}));
}

function bindInlineActions() {
  document.querySelectorAll('button[data-action][data-listing-id]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const action = btn.getAttribute('data-action');
      const listingId = btn.getAttribute('data-listing-id');
      const endpoints = {
        reserve: `{% url 'marketplace:api_listing_reserve' 0 %}`.replace('/0/', `/${listingId}/`),
        sell: `{% url 'marketplace:api_listing_sell' 0 %}`.replace('/0/', `/${listingId}/`),
        complete: `{% url 'marketplace:api_listing_complete' 0 %}`.replace('/0/', `/${listingId}/`),
      };
      try {
        if (action === 'sell') {
          openPaymentForm(btn, endpoints[action]);
        } else {
          const data = await postJSON(endpoints[action], {});
          showMarketplaceToast(`${action.charAt(0).toUpperCase() + action.slice(1)} succeeded`, 'success');
          window.location.reload();
        }
      } catch (err) {
        console.error(err);
        showMarketplaceToast(`Action failed: ${err.message}`, 'error');
      }
    });
  });
}

document.addEventListener('DOMContentLoaded', bindInlineActions);

// Render an inline payment capture form next to the clicked button
function openPaymentForm(anchorBtn, submitUrl) {
  // Avoid duplicating forms
  const existing = anchorBtn.parentElement.querySelector('.payment-form');
  if (existing) { existing.remove(); }
  const wrapper = document.createElement('div');
  wrapper.className = 'payment-form mt-3 p-3 border rounded bg-base-200';
  wrapper.innerHTML = `
    <div class="flex flex-col gap-2">
      <div class="text-sm font-semibold">Record Payment</div>
      <div class="flex gap-2 items-center">
        <label class="text-sm w-28">Method</label>
        <select name="payment_method" class="select select-bordered select-sm w-40">
          <option value="cash">Cash</option>
          <option value="bank_transfer">Bank Transfer</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="flex gap-2 items-center">
        <label class="text-sm w-28">Amount Paid</label>
        <input name="amount_paid" type="number" step="0.01" min="0" class="input input-bordered input-sm w-40" />
      </div>
      <div class="flex gap-2 items-center">
        <label class="text-sm w-28">Proof (optional)</label>
        <input name="payment_proof" type="file" class="file-input file-input-bordered file-input-sm w-64" />
      </div>
      <div class="flex gap-2 mt-2">
        <button type="button" class="btn btn-primary btn-sm" data-role="submit-payment">Submit</button>
        <button type="button" class="btn btn-ghost btn-sm" data-role="cancel-payment">Cancel</button>
      </div>
    </div>
  `;
  anchorBtn.parentElement.appendChild(wrapper);

  const submitBtn = wrapper.querySelector('[data-role="submit-payment"]');
  const cancelBtn = wrapper.querySelector('[data-role="cancel-payment"]');
  submitBtn.addEventListener('click', async () => {
    const formData = new FormData();
    const method = wrapper.querySelector('select[name="payment_method"]').value;
    const amount = wrapper.querySelector('input[name="amount_paid"]').value;
    const proof = wrapper.querySelector('input[name="payment_proof"]').files[0];
    formData.append('payment_method', method);
    if (amount) formData.append('amount_paid', amount);
    if (proof) formData.append('payment_proof', proof);
    try {
      const resp = await fetch(submitUrl, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData,
      });
      if (!resp.ok) {
        let data = {};
        try { data = await resp.json(); } catch (_) {}
        const msg = data.error || 'Failed to record payment';
        const fe = data.field_errors || {};
        const details = Object.entries(fe).map(([k,v]) => `${k}: ${v}`).join(', ');
        showMarketplaceToast(details ? `${msg} — ${details}` : msg, 'error');
        return;
      }
      showMarketplaceToast('Payment recorded', 'success');
      window.location.reload();
    } catch (err) {
      console.error(err);
      showMarketplaceToast('Failed to record payment', 'error');
    }
  });
  cancelBtn.addEventListener('click', () => wrapper.remove());
}
</script>
{% endblock %}

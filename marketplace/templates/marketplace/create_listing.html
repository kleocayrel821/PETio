{% extends "marketplace/base_marketplace.html" %}
{% load static %}
<!-- Create Listing Page: modern, accessible, and interactive form for new listings -->
{% block marketplace_title %}Create Listing{% endblock %}
{% block marketplace_header %}Create New Listing{% endblock %}
{% block marketplace_subtitle %}Add details, upload an image, and preview before submitting{% endblock %}
{% block breadcrumbs %}
<li><a href="{% url 'marketplace:home' %}">Marketplace</a></li>
<li>Create Listing</li>
{% endblock %}

{% block marketplace_content %}
<style>
  /* Page-specific styles for enhanced visual hierarchy and micro-interactions */
  .form-section { border: 1px solid var(--fallback-bc, oklch(var(--bc)/.1)); border-radius: .75rem; background: var(--fallback-b1, oklch(var(--b1))); }
  .form-section + .form-section { margin-top: 1rem; }
  .form-section .section-header { display:flex; align-items:center; gap:.5rem; padding:.75rem 1rem; border-bottom: 1px dashed var(--fallback-bc, oklch(var(--bc)/.1)); background: var(--fallback-b2, oklch(var(--b2))); border-top-left-radius:.75rem; border-top-right-radius:.75rem; }
  .field { display:flex; flex-direction:column; gap:.375rem; }
  .field .hint { font-size:.75rem; color: color-mix(in oklab, currentColor 60%, transparent); }
  .field .counter { font-size:.75rem; color: color-mix(in oklab, currentColor 60%, transparent); }
  .field.invalid input, .field.invalid textarea, .field.invalid select { outline: 2px solid oklch(60% .15 25); }
  .field.valid input, .field.valid textarea, .field.valid select { outline: 2px solid oklch(60% .15 150); }
  .dropzone { border: 2px dashed var(--fallback-bc, oklch(var(--bc)/.3)); border-radius: .75rem; padding: 1rem; text-align:center; cursor:pointer; transition: border-color .2s ease, background .2s ease; }
  .dropzone.dragover { border-color: oklch(70% .15 250); background: oklch(95% .02 250 / .35); }
  .touch-target { min-height: 44px; }
  .soft-divider { height:1px; background: linear-gradient(to right, transparent, oklch(50% .02 250 / .2), transparent); margin: .75rem 0; }
  .progress-labels { display:flex; align-items:center; justify-content:space-between; font-size:.75rem; color: color-mix(in oklab, currentColor 60%, transparent); }
  .visually-hidden { position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0 0 0 0); border:0; }
  .btn-loading { position:relative; }
  .btn-loading[aria-busy="true"]::after { content:""; position:absolute; right:.75rem; width:1rem; height:1rem; border:2px solid currentColor; border-right-color: transparent; border-radius:50%; animation: spin .8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<!-- Progress indicator -->
<div class="mb-4">
  <div class="progress-labels">
    <span><i class="fas fa-list"></i> Details</span>
    <span><i class="fas fa-image"></i> Media</span>
    <span><i class="fas fa-eye"></i> Preview</span>
  </div>
  <progress id="formProgress" class="progress progress-primary w-full" value="0" max="100" aria-label="Form completion"></progress>
</div>

<!-- Autosave indicator -->
<div id="autosaveIndicator" class="badge badge-ghost mb-2" aria-live="polite" aria-atomic="true">
  <i class="fas fa-save mr-1"></i> Draft not saved
  <span class="visually-hidden">Autosave status</span>
  <span id="autosaveTime" class="ml-1"></span>
  <button type="button" id="restoreDraftBtn" class="btn btn-ghost btn-xs ml-2">Restore draft</button>
  <button type="button" id="clearDraftBtn" class="btn btn-ghost btn-xs">Clear</button>
  <span id="autosaveStatus" class="ml-2 text-xs"></span>
  <div class="soft-divider"></div>
</div>

<div class="card bg-base-100 shadow-md sm:shadow-lg p-4 sm:p-6 rounded-xl">
  <form id="createListingForm" method="post" enctype="multipart/form-data" novalidate role="form" aria-labelledby="create-listing-title">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <div class="alert alert-error mb-4" role="alert" aria-live="polite">
      <ul class="list-disc pl-5">
        {% for err in form.non_field_errors %}
        <li>{{ err }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <!-- Section: Listing Details -->
    <section class="form-section">
      <div class="section-header">
        <i class="fas fa-list text-primary"></i>
        <h2 class="text-base font-semibold">Listing Details</h2>
      </div>
      <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="field min-w-0" id="field-title" aria-live="polite">
          <label class="subsection-title" for="{{ form.title.id_for_label }}">
            <i class="fas fa-tag text-blue-400" title="A concise, clear product name"></i> Title
          </label>
          <div class="w-full">{{ form.title }}</div>
          <div class="flex justify-between">
            <span class="hint">Keep it short and descriptive (e.g., "Stainless Steel Pet Bowl")</span>
            <span class="counter"><span id="titleCount">0</span>/<span id="titleMax">{{ form.title.field.max_length|default:120 }}</span></span>
          </div>
          {% if form.title.errors %}
            <label class="label" role="alert" aria-live="polite"><span class="label-text-alt text-error">{{ form.title.errors.0 }}</span></label>
          {% endif %}
        </div>

        <div class="field min-w-0" id="field-category" aria-live="polite">
          <label class="subsection-title" for="{{ form.category.id_for_label }}">
            <i class="fas fa-list text-purple-400" title="Select the most relevant category"></i> Category
          </label>
          <div class="w-full">{{ form.category }}</div>
          <span class="hint">Choose a category to help buyers find your item</span>
          {% if form.category.errors %}
            <label class="label" role="alert" aria-live="polite"><span class="label-text-alt text-error">{{ form.category.errors.0 }}</span></label>
          {% endif %}
        </div>

        <div class="field min-w-0" id="field-price" aria-live="polite">
          <label class="subsection-title" for="{{ form.price.id_for_label }}">
            <i class="fas fa-peso-sign text-yellow-400" title="Enter a fair, competitive price"></i> Price
          </label>
          <div class="w-full">{{ form.price }}</div>
          <span class="hint">Set a competitive price (e.g., 19.99)</span>
          {% if form.price.errors %}
            <label class="label" role="alert" aria-live="polite"><span class="label-text-alt text-error">{{ form.price.errors.0 }}</span></label>
          {% endif %}
        </div>
      </div>

      <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="field min-w-0" id="field-quantity" aria-live="polite">
          <label class="subsection-title" for="{{ form.quantity.id_for_label }}">
            <i class="fas fa-cubes text-pink-400" title="How many units are available"></i> Quantity
          </label>
          <div class="w-full">{{ form.quantity }}</div>
          <span class="hint">Enter the number of items you can sell</span>
          {% if form.quantity.errors %}
            <label class="label" role="alert" aria-live="polite"><span class="label-text-alt text-error">{{ form.quantity.errors.0 }}</span></label>
          {% endif %}
        </div>

        <div class="field min-w-0" id="field-main-image" aria-live="polite">
          <label class="subsection-title" for="{{ form.main_image.id_for_label }}">
            <i class="fas fa-file-upload text-teal-400" title="Upload a clear, well-lit product photo"></i> Main Image
          </label>
          <!-- Custom dropzone wrapping the built-in file input -->
          <div id="imageDropzone" class="dropzone" tabindex="0" role="button" aria-label="Image upload area" aria-describedby="imageHelp">
            <div class="text-sm text-base-content/70 mb-2">
              Drag & drop an image here, or click to select
            </div>
            <div class="flex justify-center mb-2">
              <img id="imagePreview" class="hidden rounded-lg max-h-48 object-cover" alt="Image preview" />
            </div>
            <button type="button" id="imageSelectBtn" class="btn btn-ghost btn-sm"><i class="fas fa-upload"></i> Choose Image</button>
            <div class="visually-hidden">{{ form.main_image }}</div>
          </div>
          <label id="imageHelp" class="label"><span class="label-text-alt">Max 5 MB. JPG/PNG/WebP recommended.</span></label>
          {% if form.main_image.errors %}
            <label class="label" role="alert" aria-live="polite"><span class="label-text-alt text-error">{{ form.main_image.errors.0 }}</span></label>
          {% endif %}
        </div>
      </div>

      <!-- Purchase Options -->
      <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="field min-w-0" id="field-is-fixed-price" aria-live="polite">
          <label class="subsection-title" for="{{ form.is_fixed_price.id_for_label }}">
            <i class="fas fa-bolt text-green-500" title="Enable instant purchase at listed price"></i> Buy Now (Fixed Price)
          </label>
          <div class="flex items-center gap-3">
            {{ form.is_fixed_price }}
            <span class="hint">When enabled, buyers can purchase immediately at your price.</span>
          </div>
          {% if form.is_fixed_price.errors %}
            <label class="label" role="alert" aria-live="polite"><span class="label-text-alt text-error">{{ form.is_fixed_price.errors.0 }}</span></label>
          {% endif %}
        </div>

        <div class="field min-w-0" id="field-allow-offers" aria-live="polite">
          <label class="subsection-title" for="{{ form.allow_offers.id_for_label }}">
            <i class="fas fa-handshake text-indigo-500" title="Allow buyers to submit price offers"></i> Allow Offers
          </label>
          <div class="flex items-center gap-3">
            {{ form.allow_offers }}
            <span class="hint">Let buyers negotiate. Disable for firm pricing.</span>
          </div>
          {% if form.allow_offers.errors %}
            <label class="label" role="alert" aria-live="polite"><span class="label-text-alt text-error">{{ form.allow_offers.errors.0 }}</span></label>
          {% endif %}
        </div>
      </div>

      <div class="p-4">
        <div class="field min-w-0" id="field-description" aria-live="polite">
          <label class="subsection-title" for="{{ form.description.id_for_label }}">
            <i class="fas fa-align-left text-orange-400" title="Describe your product and its condition"></i> Description
          </label>
          <div class="w-full">{{ form.description }}</div>
          <div class="flex justify-between">
            <span class="hint">Include condition, size, materials, and any special features</span>
            <span class="counter"><span id="descCount">0</span> chars</span>
          </div>
          {% if form.description.errors %}
            <label class="label" role="alert" aria-live="polite"><span class="label-text-alt text-error">{{ form.description.errors.0 }}</span></label>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Section: Preview & Submit -->
    <section class="form-section mt-4">
      <div class="section-header">
        <i class="fas fa-eye text-primary"></i>
        <h2 class="text-base font-semibold">Preview & Submit</h2>
      </div>
      <div class="p-4 flex flex-col sm:flex-row justify-end gap-2">
        <a href="{% url 'marketplace:home' %}" class="btn btn-ghost w-full sm:w-auto touch-target" aria-label="Cancel and go back">Cancel</a>
        <button type="button" id="previewBtn" class="btn btn-ghost w-full sm:w-auto touch-target" aria-label="Preview listing"><i class="fas fa-eye"></i> Preview</button>
        <button type="submit" id="submitBtn" class="btn btn-primary w-full sm:w-auto touch-target btn-loading" aria-label="Submit new listing" aria-busy="false"><i class="fas fa-save"></i> Submit</button>
      </div>
    </section>
  </form>
</div>

<!-- Preview Modal -->
<dialog id="previewModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg"><i class="fas fa-eye mr-2"></i>Listing Preview</h3>
    <div class="soft-divider"></div>
    <div class="space-y-3">
      <div class="text-sm text-base-content/70">This is how your listing will appear to buyers.</div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <div class="rounded-xl bg-base-200 flex items-center justify-center h-48 overflow-hidden">
            <img id="previewImage" alt="Preview image" class="hidden max-h-48 object-cover">
            <i id="previewPlaceholder" class="fas fa-image text-base-content/30 text-4xl"></i>
          </div>
        </div>
        <div>
          <div class="text-xl font-semibold" id="previewTitle">Title</div>
          <div class="text-sm opacity-70" id="previewCategory">Category</div>
          <div class="text-lg text-primary font-bold" id="previewPrice">₱0.00</div>
          <div class="text-sm opacity-70" id="previewStock">Stock: —</div>
          <div class="soft-divider"></div>
          <div id="previewDescription" class="text-sm leading-relaxed">Description</div>
        </div>
      </div>
    </div>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn">Close</button>
      </form>
    </div>
  </div>
</dialog>
{% endblock %}

{% block marketplace_scripts %}
<!-- Page script: interactions, validation, preview, autosave -->
<script src="{% static 'marketplace/create_listing.js' %}"></script>
<script>
  // Initialize page interactions when the DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    window.CreateListingPage?.init?.({
      selectors: {
        form: '#createListingForm',
        title: '#{{ form.title.id_for_label }}',
        price: '#{{ form.price.id_for_label }}',
        quantity: '#{{ form.quantity.id_for_label }}',
        category: '#{{ form.category.id_for_label }}',
        description: '#{{ form.description.id_for_label }}',
        mainImageInput: '#{{ form.main_image.id_for_label }}',
        imageDropzone: '#imageDropzone',
        imagePreview: '#imagePreview',
        imageSelectBtn: '#imageSelectBtn',
        progress: '#formProgress',
        titleCount: '#titleCount',
        titleMax: '#titleMax',
        descCount: '#descCount',
        autosaveIndicator: '#autosaveIndicator',
        autosaveTime: '#autosaveTime',
        restoreDraftBtn: '#restoreDraftBtn',
        clearDraftBtn: '#clearDraftBtn',
        previewBtn: '#previewBtn',
        submitBtn: '#submitBtn',
        previewModal: '#previewModal',
        previewTitle: '#previewTitle',
        previewCategory: '#previewCategory',
        previewPrice: '#previewPrice',
        previewStock: '#previewStock',
        previewDescription: '#previewDescription',
        previewImage: '#previewImage',
        previewPlaceholder: '#previewPlaceholder'
      }
    });
  });
</script>
{% endblock %}
{% extends 'base.html' %}
{% load static %}
{% load avatar %}

{% block title %}{{ profile_user.username }} (@{{ profile_user.username }}) â€¢ PETio{% endblock %}

{% block body_class %} class="social-no-gradient" {% endblock %}

{% block extra_head %}
<style>
    :root {
        --primary-color: #9370DB; /* Medium Purple */
        --secondary-color: #F472B6; /* Pink accent */
        --accent-color: #A78BFA; /* Soft violet */
        --success-color: #22c55e;
        --background-color: #f6f7fb;
        --card-background: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --border-color: rgba(147,112,219,0.25);
        --hover-color: #f1f5f9;
    }

    body {
        background-color: var(--background-color);
        font-family: 'Rubik', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* Cover Photo & Header */
    .profile-cover {
        height: 200px;
        background: linear-gradient(135deg, #6d28d9 0%, #ec4899 100%);
        position: relative;
        overflow: hidden;
    }

    .profile-cover::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    }

    .profile-info-container {
        max-width: 900px;
        width: 100%;
        margin: 0 auto;
        padding: 0 20px;
        position: relative;
    }

    .profile-avatar-container {
        position: absolute;
        top: -75px;
        left: 20px;
        z-index: 10;
    }

    /* Compact avatar size per spec */
    .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 5px solid white;
        background: white;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        object-fit: cover;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: var(--text-secondary);
    }

    /* Compact header card padding and denser look */
    .profile-header-content {
        background: rgba(255,255,255,0.85);
        border-radius: 12px;
        padding: 8px 8px 4px 108px;
        margin-top: -4px;
        box-shadow: 0 10px 24px rgba(124,58,237,0.08);
        border: none;
        position: relative;
        backdrop-filter: saturate(180%) blur(6px);
    }
    .profile-header-content::after {
        content: "";
        position: absolute;
        left: 8px;
        right: 8px;
        bottom: -2px;
        height: 2px;
        background: linear-gradient(90deg, var(--primary-color) 0%, #4c1d95 100%);
        border-radius: 2px;
        opacity: 0.6;
    }

    .profile-actions-header {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 10px;
    }

    .profile-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
        line-height: 1.2;
    }

    .profile-username {
        color: var(--text-secondary);
        font-size: 0.95rem;
        margin: 0 0 6px;
    }

    .profile-bio {
        color: var(--text-primary);
        font-size: 1rem;
        line-height: 1.5;
        margin: 15px 0;
    }

    .profile-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 6px 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .profile-meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* More compact stats and grid layout */
    .profile-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 8px 0;
        align-items: center;
        justify-content: center;
        transform: translateX(-44px);
    }

    .stat-item {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--text-primary);
        text-decoration: none;
        transition: all 0.2s ease;
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: 9999px; /* pill */
        padding: 6px 10px;
        box-shadow: none;
        min-height: auto;
        justify-content: flex-start;
        text-align: left;
    }

    .stat-item i { margin-right: 4px; }

    .stat-item:hover {
        color: var(--primary-color);
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.08);
    }

    .stat-number {
        font-weight: 700;
        font-size: 0.9rem;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.8rem;
    }

    /* Modern Buttons */
    .btn-modern {
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        padding: 8px 20px;
        border: 1px solid;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-follow {
        background: var(--text-primary);
        color: white;
        border-color: var(--text-primary);
    }

    .btn-follow:hover {
        background: #32383e;
        color: white;
        transform: translateY(-1px);
    }

    .btn-following {
        background: transparent;
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    .btn-following:hover {
        background: #fef7f7;
        color: #dc3545;
        border-color: #dc3545;
    }

    .btn-edit {
        background: transparent;
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    .btn-edit:hover {
        background: var(--hover-color);
        color: var(--text-primary);
    }

    /* Posts Grid */
    .posts-section {
        max-width: 900px;
        margin: 24px auto 0;
        padding: 0 20px;
    }

    .posts-header {
        background: var(--card-background);
        border-radius: 16px 16px 0 0;
        padding: 16px 20px;
        border: 1px solid var(--border-color);
        border-bottom: none;
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 6px 12px rgba(0,0,0,0.06);
    }

    .posts-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .post-item {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 22px;
        padding: 16px;
        transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        box-shadow: 0 10px 24px rgba(17,24,39,0.06);
        margin-bottom: 16px;
    }

    .post-item:hover {
        background: var(--hover-color);
        transform: translateY(-1px);
        box-shadow: 0 10px 18px rgba(0,0,0,0.08);
    }

    .post-item:last-child {
        border-radius: 0 0 16px 16px;
    }

    .post-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .post-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        font-size: 0.9rem;
        flex-grow: 1;
    }

    .post-title {
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 6px;
        line-height: 1.3;
    }

    .post-content {
        color: var(--text-primary);
        line-height: 1.45;
        margin: 10px 0;
    }

    .post-image {
        border-radius: 12px;
        margin: 10px 0;
        max-height: 360px;
        width: 100%;
        object-fit: cover;
        box-shadow: 0 8px 16px rgba(0,0,0,0.06);
    }

    .post-engagement {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--border-color);
    }

    .engagement-buttons {
        display: flex;
        gap: 20px;
    }

    .engagement-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 20px;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .engagement-btn:hover {
        background: var(--hover-color);
    }

    .engagement-btn.liked {
        color: #e91e63;
    }

    .engagement-btn.liked:hover {
        background: #fce4ec;
    }

    .read-more-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        font-weight: 600;
        font-size: 0.9rem;
        padding: 6px 12px;
        border-radius: 20px;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .read-more-btn:hover {
        background: #e8f5fe;
    }

    /* Empty State */
    .empty-state {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 40px 24px;
        text-align: center;
        margin-top: 24px;
        }

    .empty-state-icon {
        width: 80px;
        height: 80px;
        background: var(--hover-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 2rem;
        color: var(--text-secondary);
    }

    .empty-state h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 10px;
    }

    .empty-state p {
        color: var(--text-secondary);
        margin: 0 0 20px;
        line-height: 1.5;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .profile-info-container {
            padding: 0 15px;
        }
        
        .profile-avatar-container {
            left: 15px;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
        }
        
        .profile-header-content {
            padding: 60px 15px 15px;
        }
        
        .posts-section {
            padding: 0 15px;
        }
        
        .profile-stats {
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            transform: none;
        }
    }

    /* Verified Badge */
    .verified-badge {
        color: var(--primary-color);
        margin-left: 4px;
    }

    /* Category Badge */
    .category-badge {
        background: var(--primary-color);
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Background pattern wrapper */
    .profile-content {
        background:
          radial-gradient(circle at 10% 10%, rgba(29,161,242,0.06) 0%, transparent 40%),
          radial-gradient(circle at 90% 20%, rgba(118,75,162,0.06) 0%, transparent 40%),
          linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.02));
        padding: 16px;
        border-radius: 16px;
        max-width: 900px;
        margin: 0 auto;
        position: relative;
    }

    /* Modern card helpers */
    .modern-card {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }
    .accent-border {
        border-left: 4px solid var(--primary-color);
    }
    .gradient-card {
        background: linear-gradient(135deg, var(--primary-color) 0%, #ec4899 100%);
        color: white;
        border-radius: 16px;
        box-shadow: 0 16px 32px rgba(109,40,217,0.25);
    }
    .card-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
    }

    /* Icon grid for quick actions */
    .icon-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
    }
    .icon-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-background);
        transition: all 0.2s ease;
        text-decoration: none;
        color: var(--text-primary);
    }
    .icon-item:hover {
        background: var(--hover-background);
        border-color: var(--primary-color);
        text-decoration: none;
    }

    /* Timeline styles */
    .timeline {
        position: relative;
        padding-left: 24px;
    }
    .timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(180deg, rgba(29,161,242,0.5), rgba(118,75,162,0.5));
    }
    .timeline-item {
        position: relative;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px dashed rgba(0,0,0,0.06);
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -16px;
        top: 4px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(29,161,242,0.2);
    }
    .timeline-title {
        font-weight: 600;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .timeline-meta {
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    /* Circular progress using conic gradient */
    .progress-ring {
        --percent: 85; /* fallback */
        width: 110px;
        height: 110px;
        border-radius: 50%;
        background:
          conic-gradient(#ffd166 calc(var(--percent) * 3.6deg), #e5e7eb 0);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 0 0 10px white;
    }
    .progress-inner {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #374151;
    }

    /* Verified badge styles */
    .verified-badge {
        color: var(--primary-color);
        margin-left: 8px;
        font-size: 1.2rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .profile-info-container {
            padding: 0 16px;
        }

        .profile-avatar-container {
            left: 16px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            font-size: 2.5rem;
        }

        .profile-header-content {
            padding: 60px 16px 16px;
        }

        .profile-name {
            font-size: 1.3rem;
        }

        .profile-stats {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            padding: 10px;
            flex-direction: column;
            text-align: center;
        }

        .stat-number {
            font-size: 1.1rem;
        }

        .stat-label {
            font-size: 0.8rem;
        }

        .icon-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .icon-item {
            min-height: 70px;
            padding: 10px 6px;
        }
        .icon-item i {
            font-size: 1.1rem;
        }


        .posts-section {
            padding: 0 16px;
        }

        .post-item {
            padding: 16px;
        }

        .profile-meta {
            flex-direction: column;
            gap: 10px;
        }

        .progress-ring {
            width: 90px;
            height: 90px;
        }

        .progress-inner {
            width: 70px;
            height: 70px;
            font-size: 0.9rem;
        }
    }

    @media (max-width: 480px) {
        .profile-cover {
            height: 150px;
        }

        .profile-avatar-container {
            top: -50px;
            left: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            font-size: 2rem;
        }

        .profile-header-content {
            padding: 45px 12px 12px 110px;
            margin-top: -30px;
        }

        .profile-name {
            font-size: 1.2rem;
        }

        .profile-username {
            font-size: 0.9rem;
        }

        .profile-stats {
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .icon-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .btn-modern {
            padding: 6px 16px;
            font-size: 0.85rem;
        }
    }
</style>
{% endblock %}

{% block sidebar %}
  {% include 'social/sidebar.html' with view_name='my_profile' %}
{% endblock %}

{% block content %}
<div class="profile-content">
  <!-- Cover Photo -->
  <div class="profile-cover"></div>

  <!-- Profile Info -->
  <div class="profile-info-container">
    <!-- Avatar -->
    <div class="profile-avatar-container">
        {% if profile.avatar %}
            <img src="{{ profile.avatar.url }}" alt="{{ profile_user.username }}" class="profile-avatar" data-viewer="image" data-group="profile-{{ profile_user.id }}">
        {% else %}
            <div class="profile-avatar">
                <i class="fas fa-user"></i>
            </div>
        {% endif %}
    </div>

    <!-- Profile Header Content -->
    <div class="profile-header-content">
        <!-- Action Buttons -->
        <div class="profile-actions-header">
            {% if not is_own_profile %}
                {% if is_following %}
                    <button class="btn-modern btn-following" onclick="toggleFollow({{ profile_user.id }})">
                        <i class="fas fa-check"></i>
                        <span class="follow-text">Following</span>
                    </button>
                {% else %}
                    <button class="btn-modern btn-follow" onclick="toggleFollow({{ profile_user.id }})">
                        <i class="fas fa-plus"></i> Follow
                    </button>
                {% endif %}
            {% else %}
                <a href="{% url 'social:edit_profile' %}" class="btn-modern btn-edit">
                    <i class="fas fa-edit"></i> Edit profile
                </a>
            {% endif %}
        </div>

        <!-- Profile Name & Username -->
        <h1 class="profile-name">
            {{ profile_user.get_full_name|default:profile_user.username }}
            {% if profile_user.is_staff %}
                <i class="fas fa-check-circle verified-badge" title="Verified"></i>
            {% endif %}
        </h1>
        <div class="profile-username">@{{ profile_user.username }}</div>

        <!-- Bio -->
        {% if profile.bio %}
            <div class="profile-bio">{{ profile.bio }}</div>
        {% endif %}

        <!-- Profile Meta -->
        <div class="profile-meta">
            {% if profile.location %}
                <div class="profile-meta-item">
                    <span class="icon-badge-soft"><i class="fas fa-map-marker-alt"></i></span>
                    <span>{{ profile.location }}</span>
                </div>
            {% endif %}
            {% if profile.website %}
                <div class="profile-meta-item">
                    <span class="icon-badge-soft"><i class="fas fa-link"></i></span>
                    <a href="{{ profile.website }}" target="_blank" rel="noopener">{{ profile.website|slice:":30" }}{% if profile.website|length > 30 %}...{% endif %}</a>
                </div>
            {% endif %}
            <div class="profile-meta-item">
                <span class="icon-badge-soft"><i class="fas fa-calendar-alt"></i></span>
                <span>Joined {{ profile_user.date_joined|date:"F Y" }}</span>
            </div>
        </div>

        <!-- Stats (clickable) -->
        <div class="profile-stats">
            <a class="stat-item" href="#postsSection" title="View posts">
                <span class="icon-badge-soft"><i class="fas fa-file-alt"></i></span>
                <span class="stat-number" id="postsCount">{{ user_posts.count }}</span>
                <span class="stat-label">Posts</span>
            </a>
            <a class="stat-item" href="#" onclick="openFollowers({{ profile_user.id }}); return false;" title="View followers">
                <span class="icon-badge-soft"><i class="fas fa-user-friends"></i></span>
                <span class="stat-number" id="followersCount">{{ profile.follower_count }}</span>
                <span class="stat-label">Followers</span>
            </a>
            <a class="stat-item" href="#" onclick="openFollowing({{ profile_user.id }}); return false;" title="View following">
                <span class="icon-badge-soft"><i class="fas fa-user-plus"></i></span>
                <span class="stat-number" id="followingCount">{{ profile.following_count }}</span>
                <span class="stat-label">Following</span>
            </a>
            <a class="stat-item" href="#" onclick="openLikes({{ profile_user.id }}); return false;" title="View likes">
                <span class="icon-badge-soft"><i class="fas fa-heart"></i></span>
                <span class="stat-number" id="likesCount">{{ profile_likes_count }}</span>
                <span class="stat-label">Likes</span>
            </a>
        </div>
    </div>

    
    {% if is_own_profile %}
    <div class="enhanced-card hover-lift" style="margin-top: 12px;">
        <div class="flex items-center gap-3">
            <div class="avatar">
                <div class="w-12 rounded-full">
                    <a href="{% url 'social:my_profile' %}" class="block">
                        <img src="{% avatar_url user 96 %}" alt="{{ user.username }}" />
                    </a>
                </div>
            </div>
            <div class="flex-1 bg-white rounded-full border border-gray-200 px-4 py-3 flex items-center gap-3 min-w-0 shadow-sm">
                <a href="{% url 'social:create_post' %}" class="flex-1 text-gray-500 hover:text-gray-700 transition-colors duration-200 min-w-0 truncate">
                    What's on your mind, {{ user.first_name|default:user.username }}?
                </a>
            </div>
        </div>
    </div>
    {% endif %}
  </div>

  

  

  <!-- Posts Section -->
  <div class="posts-section" id="postsSection">
    {% if user_posts %}
        <!-- Posts Header -->
        <div class="posts-header">
            <h2 class="posts-title">
                <span class="icon-badge-soft icon-inline"><i class="fas fa-newspaper"></i></span>
                Posts
            </h2>
        </div>

        <!-- Posts List -->
        {% for post in user_posts %}
            <div class="post-item" onclick="window.location.href='{% url 'social:post_detail' post.id %}'">
                <!-- Post Header with author and time -->
                <div class="post-header flex justify-between items-start">
                    <div class="flex items-start gap-3">
                        <div class="avatar">
                            <div class="w-12 rounded-full">
                                <a href="{% url 'social:profile' post.author.username %}" class="block">
                                    <img src="{% avatar_url post.author 96 %}" alt="{{ post.author.username }}" />
                                </a>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <h4 class="font-semibold">
                                    <a href="{% url 'social:profile' post.author.username %}" class="hover:text-primary">
                                        {{ post.author.get_full_name|default:post.author.username }}
                                    </a>
                                </h4>
                                <span class="text-sm text-base-content/60">{{ post.created_at|timesince }} ago</span>
                            </div>
                        </div>
                    </div>
                    {% if is_own_profile %}
                        <div class="dropdown dropdown-end">
                            <label tabindex="0" class="btn btn-ghost btn-sm" onclick="event.stopPropagation()">
                                <i class="fas fa-ellipsis-h"></i>
                            </label>
                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52" onclick="event.stopPropagation()">
                                <li><a href="{% url 'social:edit_post' post.pk %}"><i class="fas fa-edit"></i> Edit</a></li>
                                <li><a href="{% url 'social:post_detail' post.pk %}"><i class="fas fa-eye"></i> View</a></li>
                                <li>
                                    <form method="POST" action="{% url 'social:delete_post' post.pk %}" 
                                          onsubmit="return confirm('Are you sure you want to delete this post?')">
                                        {% csrf_token %}
                                        <button type="submit" class="text-red-500">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    {% endif %}
                </div>

                <!-- Post Content -->
                {% if post.title %}
                    <h3 class="post-title">{{ post.title }}</h3>
                {% endif %}
                
                <div class="post-content">
                    {% if post.content|length > 200 %}
                        {{ post.content|slice:":200" }}...
                        <button class="read-more-btn" onclick="event.stopPropagation()">
                            Read more
                        </button>
                    {% else %}
                        {{ post.content }}
                    {% endif %}
                </div>

                {% with imgs=post.images.all %}
                {% if imgs|length > 1 %}
                <div class="mb-4 grid grid-cols-2 gap-3">
                    {% for img in imgs %}
                    <a href="{% url 'social:post_detail' post.pk %}" class="block">
                        <img src="{{ img.image.url }}" alt="{{ post.title }}"
                             loading="lazy"
                             data-viewer="image" data-group="post-{{ post.pk }}"
                             class="rounded-lg w-full object-cover max-h-64 sm:max-h-72 md:max-h-80" />
                    </a>
                    {% endfor %}
                </div>
                {% elif imgs|length == 1 %}
                <div class="mb-4">
                    {% for img in imgs %}
                    <a href="{% url 'social:post_detail' post.pk %}" class="block">
                        <img src="{{ img.image.url }}" alt="{{ post.title }}"
                             loading="lazy"
                             data-viewer="image" data-group="post-{{ post.pk }}"
                             class="rounded-lg w-full object-cover max-h-64 sm:max-h-72 md:max-h-80" />
                    </a>
                    {% endfor %}
                </div>
                {% elif post.image %}
                <div class="mb-4">
                    <a href="{% url 'social:post_detail' post.pk %}" class="block">
                        <img src="{{ post.image.url }}" alt="{{ post.title }}"
                             loading="lazy"
                             data-viewer="image" data-group="post-{{ post.pk }}"
                             class="rounded-lg w-full object-cover max-h-64 sm:max-h-72 md:max-h-80" />
                    </a>
                </div>
                {% endif %}
                {% endwith %}

                {% with vids=post.videos.all %}
                {% if vids|length > 0 %}
                <div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                    {% for v in vids %}
                    <a href="{% url 'social:post_detail' post.pk %}" class="block">
                        <video src="{{ v.file.url }}" preload="metadata" controls
                               class="rounded-lg w-full object-cover max-h-64 sm:max-h-72 md:max-h-80"></video>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
                {% endwith %}

                <!-- Post Engagement -->
                <div class="post-engagement">
                    <div class="engagement-buttons">
                        <button class="engagement-btn {% if post.id in viewer_liked_post_ids %}liked{% endif %}" 
                                onclick="event.stopPropagation(); toggleLike({{ post.id }})">
                            <i class="fas fa-heart"></i>
                            <span>{{ post.likes.count }}</span>
                        </button>
                        <button class="engagement-btn" onclick="event.stopPropagation()">
                            <i class="fas fa-comment"></i>
                            <span>{{ post.comments.count }}</span>
                        </button>
                        <button class="engagement-btn" onclick="event.stopPropagation()">
                            <i class="fas fa-share"></i>
                        </button>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-newspaper"></i>
            </div>
            <h3>No posts yet</h3>
            <p>
                {% if is_own_profile %}
                    Share your first post with the PETio community! Your thoughts, experiences, and pet stories are what make this place special.
                {% else %}
                    {{ profile_user.username }} hasn't shared any posts yet. Check back later to see what they're up to!
                {% endif %}
            </p>
            {% if is_own_profile %}
                <a href="{% url 'social:create_post' %}" class="btn-modern btn-follow">
                    <i class="fas fa-plus"></i> Create your first post
                </a>
            {% endif %}
        </div>
    {% endif %}
  </div>
</div>

<!-- Simple Modal for Followers/Following/Likes -->
<div id="listModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#fff; color:#111; width:92%; max-width:640px; border-radius:10px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
    <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid rgba(0,0,0,0.08);">
      <h3 id="listModalTitle" class="card-title" style="margin:0;">List</h3>
      <button onclick="closeListModal()" class="btn btn-ghost btn-sm"><i class="fas fa-times"></i></button>
    </div>
    <div id="listModalBody" style="max-height:60vh; overflow:auto; padding:12px 16px;"></div>
  </div>
  
  <!-- lightweight styles to match existing components -->
  <style>
    .user-row { display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:8px; }
    .user-row:hover { background: rgba(0,0,0,0.04); }
    .user-avatar { width:36px; height:36px; border-radius:50%; object-fit:cover; background:#eee; }
    .user-name { font-weight:600; }
    .subtle { opacity:0.8; font-size: 12px; }
    .post-row { padding:10px 12px; border-radius:8px; display:flex; gap:10px; align-items:flex-start; }
    .post-row:hover { background: rgba(0,0,0,0.04); }
    .post-thumb { width:56px; height:56px; border-radius:8px; object-fit:cover; background:#eee; }
    .post-title { font-weight:600; margin-bottom:4px; }
    .post-excerpt { opacity:0.85; font-size: 13px; }
  </style>
</div>

{% block extra_js %}
<script>
function toggleFollow(userId) {
    const button = document.querySelector('.btn-following, .btn-follow');
    if (!button) return;
    const originalContent = button.innerHTML;

    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    button.disabled = true;

    const csrfToken = (document.cookie.match(/csrftoken=([^;]+)/) || [null, ''])[1];
    const url = "{% url 'social:toggle_follow' profile_user.id %}";

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Accept': 'application/json',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data && typeof data.following !== 'undefined') {
            if (data.following) {
                button.className = 'btn-modern btn-following';
                button.innerHTML = '<i class="fas fa-check"></i> <span class="follow-text">Following</span>';
            } else {
                button.className = 'btn-modern btn-follow';
                button.innerHTML = '<i class="fas fa-plus"></i> Follow';
            }

            // Update follower count if element exists
            const followerCountEl = document.getElementById('followersCount');
            if (followerCountEl && typeof data.follower_count !== 'undefined') {
                followerCountEl.textContent = data.follower_count;
            }
        } else {
            button.innerHTML = originalContent;
            alert('Error: ' + (data && data.error ? data.error : 'Unable to toggle follow'));
        }
        button.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        button.innerHTML = originalContent;
        button.disabled = false;
        alert('An error occurred. Please try again.');
    });
}

function toggleLike(postId) {
    const button = document.querySelector(`[onclick*="toggleLike(${postId})"]`);
    const heartIcon = button.querySelector('i');
    const countSpan = button.querySelector('span');
    const currentCount = parseInt(countSpan.textContent);
    const isLiked = button.classList.contains('liked');
    
    // Optimistic update
    if (isLiked) {
        button.classList.remove('liked');
        heartIcon.className = 'fas fa-heart';
        countSpan.textContent = currentCount - 1;
    } else {
        button.classList.add('liked');
        heartIcon.className = 'fas fa-heart';
        countSpan.textContent = currentCount + 1;
    }
    
    fetch(`/social/like/${postId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update with actual count from server
            countSpan.textContent = data.likes_count;
            if (data.is_liked) {
                button.classList.add('liked');
            } else {
                button.classList.remove('liked');
            }
        } else {
            // Revert optimistic update on error
            if (isLiked) {
                button.classList.add('liked');
                countSpan.textContent = currentCount;
            } else {
                button.classList.remove('liked');
                countSpan.textContent = currentCount;
            }
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Revert optimistic update on error
        if (isLiked) {
            button.classList.add('liked');
            countSpan.textContent = currentCount;
        } else {
            button.classList.remove('liked');
            countSpan.textContent = currentCount;
        }
        alert('An error occurred. Please try again.');
    });
}

function editPost(postId) {
    window.location.href = `/social/edit/${postId}/`;
}

function deletePost(postId) {
    if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        fetch(`/social/delete/${postId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the post element with animation
                const postElement = document.querySelector(`[onclick*="post_detail/${postId}"]`);
                if (postElement) {
                    postElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    postElement.style.opacity = '0';
                    postElement.style.transform = 'translateY(-20px)';
                    setTimeout(() => {
                        postElement.remove();
                        // Check if no posts left and show empty state
                        const postsContainer = document.querySelector('.posts-section');
                        const remainingPosts = postsContainer.querySelectorAll('.post-item');
                        if (remainingPosts.length === 0) {
                            location.reload();
                        }
                    }, 300);
                }
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
}

// Add smooth hover effects
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effect to follow button
    const followBtn = document.querySelector('.btn-following');
    if (followBtn) {
        followBtn.addEventListener('mouseenter', function() {
            const followText = this.querySelector('.follow-text');
            if (followText) {
                followText.textContent = 'Unfollow';
            }
        });
        
        followBtn.addEventListener('mouseleave', function() {
            const followText = this.querySelector('.follow-text');
            if (followText) {
                followText.textContent = 'Following';
            }
        });
    }
    
    // Add click animation to engagement buttons
    const engagementBtns = document.querySelectorAll('.engagement-btn');
    engagementBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
        });
    });
});

// --- Modal helpers ---
function openListModal(title) {
  const m = document.getElementById('listModal');
  const t = document.getElementById('listModalTitle');
  const b = document.getElementById('listModalBody');
  if (!m || !t || !b) return;
  t.textContent = title;
  b.innerHTML = '<div style="padding:12px 0; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
  m.style.display = 'flex';
}

function closeListModal() {
  const m = document.getElementById('listModal');
  if (m) m.style.display = 'none';
}

function renderUsers(items) {
  const body = document.getElementById('listModalBody');
  if (!body) return;
  if (!items || items.length === 0) {
    body.innerHTML = '<p class="subtle">No users found.</p>';
    return;
  }
  body.innerHTML = items.map(u => `
    <a class="user-row" href="${u.profile_url}" title="View profile">
      <img class="user-avatar" src="${u.avatar_url || '/static/img/default-avatar.png'}" alt="${u.username}">
      <div>
        <div class="user-name">${u.username}</div>
        ${u.extra ? `<div class="subtle">${u.extra}</div>` : ''}
      </div>
    </a>
  `).join('');
}

function renderPosts(items) {
  const body = document.getElementById('listModalBody');
  if (!body) return;
  if (!items || items.length === 0) {
    body.innerHTML = '<p class="subtle">No liked posts.</p>';
    return;
  }
  body.innerHTML = items.map(p => `
    <a class="post-row" href="${p.url}" title="Open post">
      ${p.image_url ? `<img class='post-thumb' src='${p.image_url}' alt='${p.title || 'Post'}'>` : ''}
      <div>
        <div class="post-title">${p.title || 'Untitled post'}</div>
        <div class="post-excerpt">${p.excerpt || ''}</div>
        <div class="subtle">${p.created_at}</div>
      </div>
    </a>
  `).join('');
}

// --- Click actions for stats ---
function openFollowers(userId) {
  openListModal('Followers');
  const url = "{% url 'social:user_followers' profile_user.id %}";
  fetch(url, { headers: { 'Accept': 'application/json' }})
    .then(r => r.json())
    .then(d => renderUsers(d.results))
    .catch(() => {
      const body = document.getElementById('listModalBody');
      if (body) body.innerHTML = '<p class="subtle">Failed to load followers.</p>';
    });
}

function openFollowing(userId) {
  openListModal('Following');
  const url = "{% url 'social:user_following' profile_user.id %}";
  fetch(url, { headers: { 'Accept': 'application/json' }})
    .then(r => r.json())
    .then(d => renderUsers(d.results))
    .catch(() => {
      const body = document.getElementById('listModalBody');
      if (body) body.innerHTML = '<p class="subtle">Failed to load following.</p>';
    });
}

function openLikes(userId) {
  openListModal('Liked Posts');
  const url = "{% url 'social:user_likes' profile_user.id %}";
  fetch(url, { headers: { 'Accept': 'application/json' }})
    .then(r => r.json())
    .then(d => renderPosts(d.results))
    .catch(() => {
      const body = document.getElementById('listModalBody');
      if (body) body.innerHTML = '<p class="subtle">Failed to load likes.</p>';
    });
}

// --- Share action ---
function shareProfile() {
  const shareData = {
    title: '{{ profile_user.username }} on PETio',
    text: 'Check out this PETio profile',
    url: window.location.href
  };
  if (navigator.share) {
    navigator.share(shareData).catch(() => {});
  } else {
    // Fallback: copy link
    const ta = document.createElement('textarea');
    ta.value = shareData.url;
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); } catch (e) {}
    document.body.removeChild(ta);
    alert('Profile link copied to clipboard');
  }
}
</script>
{% endblock %}
{% endblock %}

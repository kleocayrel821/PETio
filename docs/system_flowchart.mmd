flowchart TD
  A[User clicks "Feed Now" in UI] --> B[POST /feed_now with device_id]
  B --> C{Device online?}
  C -->|No| C1[Return 503 Service Unavailable]
  C1 --> C2[UI shows offline toast]
  C -->|Yes| D[Create PendingCommand (pending)]
  D --> E[Device polls GET /api/device/command/]
  E --> F[Server returns next command; marks processing]
  F --> G[Device executes command]
  G --> H{Execution success?}
  H -->|No| I[POST /api/device/command/ack/ with error]
  I --> J[PendingCommand -> error]
  J --> K[Create FeedingLog (status:error)]
  K --> L[UI updates history]
  H -->|Yes| M[POST /api/device/command/ack/ completed]
  M --> N[PendingCommand -> completed]
  N --> O[Create FeedingLog (status:success)]
  O --> P[UI updates history]

  subgraph Alternate Paths
    D1[Duplicate feed detected]
    D1 --> D2[Return 409 Conflict]
    D2 --> D3[UI shows duplicate/conflict toast]
  end